<script>
  // Huidige datum tonen
  document.getElementById("today").textContent = new Date().toLocaleDateString("nl-BE", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

  const ICS_URL = "https://agenda-proxy.onrender.com/agenda.ics";

  // ICS parser
  function parseICS(data) {
    const lines = data.split(/\r?\n/);
    const events = [];
    let current = null;

    lines.forEach(line => {
      if (line.startsWith("BEGIN:VEVENT")) current = {};
      else if (line.startsWith("END:VEVENT")) {
        if (current) events.push(current);
        current = null;
      } else if (current) {
        if (line.startsWith("SUMMARY:")) current.summary = line.replace("SUMMARY:", "");
        else if (line.startsWith("DTSTART")) current.start = parseICSDatetime(line);
        else if (line.startsWith("DTEND")) current.end = parseICSDatetime(line);
        else if (line.startsWith("LOCATION:")) current.location = line.replace("LOCATION:", "");
      }
    });

    const today = new Date();
    return events.filter(ev => ev.start >= today).sort((a,b) => a.start - b.start);
  }

  function parseICSDatetime(line) {
    // Verwijder DTSTART: of DTSTART;TZID=Europe/Brussels: prefix
    let str = line.replace(/^DTSTART.*:/, '');

    // UTC tijd
    const matchUTC = str.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z$/);
    if (matchUTC) {
      const [, y,m,d,h,min,s] = matchUTC;
      return new Date(Date.UTC(y, m-1, d, h, min, s));
    }

    // Lokale tijd zonder Z
    const matchLocal = str.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})$/);
    if (matchLocal) {
      const [, y,m,d,h,min,s] = matchLocal;
      return new Date(y, m-1, d, h, min, s);
    }

    // Fallback
    return new Date(str);
  }

  function formatDate(d) {
    return d.toLocaleDateString("nl-BE", { weekday:"short", day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
  }

  async function loadAgenda() {
    const list = document.getElementById("agendaList");
    list.innerHTML = "Ladenâ€¦";

    try {
      const res = await fetch(ICS_URL);
      if (!res.ok) throw new Error("Netwerkfout bij laden agenda");
      const txt = await res.text();
      const events = parseICS(txt);

      if (events.length === 0) {
        list.innerHTML = "<p>Geen aankomende evenementen.</p>";
        return;
      }

      list.innerHTML = "";
      events.forEach(ev => {
        const el = document.createElement("div");
        el.className = "event";
        el.innerHTML = `
          <div class="event-date">${formatDate(ev.start)}</div>
          <div class="event-title">${ev.summary}</div>
          <div class="event-desc">${ev.location || ""}</div>
        `;
        list.appendChild(el);
      });
    } catch (err) {
      console.error("Fout bij laden agenda:", err);
      list.innerHTML = "<p>Kon agenda niet laden.</p>";
    }
  }

  // Live load bij openen
  window.addEventListener("load", loadAgenda);

  // Automatische verversing elke 15 minuten
  setInterval(loadAgenda, 15*60*1000);
</script>
