<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; }
  .container { max-width:900px; margin:20px auto; padding:10px; }
  h2 { margin-top:20px; }
  .day-card { margin-bottom:20px; }
  .event-card { border-radius:10px; padding:10px; margin:5px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .event-card.google { background:#dce7ff; }   /* lichtblauw voor Google events */
  .event-card.firebase { background:#d4ffd4; } /* lichtgroen voor voertuigreservaties */
  .event-card div { margin:3px 0; }
  .header-logo { height:50px; }
  #appHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .backlink { display:inline-block; margin-bottom:15px; text-decoration:none; color:#555; }
  .backlink .arrow { font-weight:bold; }
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo" alt="Brandweer Herentals">
    </div>
    <div class="header-right">
      <div class="header-greeting">Welkom</div>
      <div class="header-name" id="userName"></div>
      <div class="header-datetime" id="datetime"></div>
    </div>
  </header>

  <div class="content">
    <a href="index.html" class="backlink"><span class="arrow">â†</span> Terug</a>
    <h2>ğŸ“… Agenda</h2>

    <div id="reservations" class="agenda-list"></div>
  </div>
</div>

<script>
/* -------------------- GEBRUIKER -------------------- */
const currentUser = localStorage.getItem("userName") || "Onbekend";
document.getElementById("userName").textContent = currentUser;

/* -------------------- ADMIN CHECK -------------------- */
const admins = ["Jonas Weckhuysen","Patrick Van Hove","Danny Van den Bergh"];
const isAdmin = admins.includes(currentUser);

/* -------------------- DATETIME -------------------- */
setInterval(() => {
  document.getElementById("datetime").textContent = new Date().toLocaleString("nl-BE");
}, 1000);

/* -------------------- FIREBASE INIT -------------------- */
const firebaseConfig = {
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
console.log("âœ… Firebase klaar");

/* -------------------- GOOGLE CALENDAR API -------------------- */
const API_KEY = "AIzaSyDLOdqVeA-SSjSN-0RtzDP4R451nqov0lE";
const CALENDAR_ID = "df2fa36fb8ea4044f8276cf20d9922d6c350e7f7604bb5ad4a53521324f78727@group.calendar.google.com";
const MAX_EVENTS = 100;

async function fetchGoogleEvents() {
  try {
    const now = new Date().toISOString();
    const endOfYear = new Date(new Date().getFullYear(),11,31,23,59,59).toISOString();
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?maxResults=${MAX_EVENTS}&orderBy=startTime&singleEvents=true&timeMin=${now}&timeMax=${endOfYear}&key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.items || [];
  } catch (err) {
    console.error("âš ï¸ Fout bij laden Google Calendar:", err);
    return [];
  }
}

/* -------------------- LIVE FIREBASE -------------------- */
db.ref("reservations").on("value", snapshot => {
  const data = snapshot.val() || {};
  const reservations = Object.keys(data)
      .map(key => ({ id: key, ...data[key] }))
      .filter(r => r.status === "Goedgekeurd" && new Date(r.to) >= new Date());
  updateAgenda(reservations);
});

/* -------------------- UPDATE AGENDA -------------------- */
async function updateAgenda(firebaseRes) {
  const wrap = document.getElementById("reservations");
  wrap.innerHTML = "";

  const googleEvents = await fetchGoogleEvents();

  const combined = [];

  // Firebase (voertuigreservaties)
  firebaseRes.forEach(r => {
    combined.push({
      type: 'firebase',
      date: new Date(r.from),
      title: r.vehicle,
      from: new Date(r.from),
      to: new Date(r.to),
      purpose: r.purpose,
      persons: r.persons,
      user: r.user
    });
  });

  // Google Calendar
  googleEvents.forEach(e => {
    const eventDate = new Date(e.start.dateTime || e.start.date);
    // filter enkel dit jaar
    if(eventDate.getFullYear() !== new Date().getFullYear()) return;

    combined.push({
      type: 'google',
      date: eventDate,
      title: e.summary || 'Geen titel',
      from: eventDate,
      to: new Date(e.end.dateTime || e.end.date),
      purpose: '',
      persons: '',
      user: ''
    });
  });

  // Sorteer op datum/tijd
  combined.sort((a,b) => a.from - b.from);

  // Render elk event apart in een kader
  combined.forEach(ev => {
    const card = document.createElement("div");
    card.className = ev.type === 'firebase' ? "event-card firebase" : "event-card google";

    if(ev.type === 'firebase'){
      card.innerHTML = `
        <div>ğŸ“… <strong>${ev.date.toLocaleDateString("nl-BE")}</strong></div>
        <div>ğŸš’ ${ev.title}</div>
        <div>â° ${ev.from.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${ev.to.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
        <div>ğŸ¯ Doel: ${ev.purpose}</div>
        <div>ğŸ‘¥ Personen: ${ev.persons}</div>
        <div>ğŸ‘¤ Door: ${ev.user}</div>
      `;
    } else {
      card.innerHTML = `
        <div>ğŸ“… <strong>${ev.date.toLocaleDateString("nl-BE")}</strong></div>
        <div>ğŸ“Œ ${ev.title}</div>
        <div>â° ${ev.from.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${ev.to.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      `;
    }

    wrap.appendChild(card);
  });
}
</script>

</body>
</html>
