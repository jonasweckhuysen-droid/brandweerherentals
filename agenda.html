<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals — Agenda</title>

<link rel="stylesheet" href="/brandweerherentals/style.css">

<script src="/brandweerherentals/header.js" defer></script>
</head>
<body>

<div class="container">

  <!-- DYNAMISCHE HEADER -->
  <header id="appHeader">
  <div class="header-left">
    <!-- Logo -->
    <img src="/brandweerherentals/icons/logo.png" alt="Brandweer Herentals" class="header-logo">
    <div id="greeting" class="header-name"></div>
  </div>

  <div class="header-right">
    <div id="datetime" class="header-datetime"></div>
    <div id="ploegOfWeek" class="header-ploeg"></div>
  </div>
</header>

  <main class="content">
    <a href="/brandweerherentals/" class="backlink">
      <span class="arrow">←</span> Terug naar start
    </a>

    <div id="agenda-container">
      <div id="agenda-loading">Agenda laden…</div>
      <div id="agenda-error" class="hidden"></div>
      <div id="agenda"></div>
    </div>
  </main>

  <footer>
    <div class="small">Versie 1.3 (Ultra-Fast ICS + Dedup)</div>
    <div class="small">Laatste update: <span id="today"></span></div>
  </footer>
</div>

<script>
// ------------------------------------------------------
// ULTRA-SNELLE AGENDA MET GOOGLE API, CACHING + DEDUPLICATIE
// ------------------------------------------------------

const CACHE_KEY = "agendaICScacheV3";
const ICS_URL = "https://www.googleapis.com/calendar/v3/calendars/df2fa36fb8ea4044f8276cf20d9922d6c350e7f7604bb5ad4a53521324f78727%40group.calendar.google.com/events?key=AIzaSyDLOdqVeA-SSjSN-0RtzDP4R451nqov0lE";
const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 min

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("today").textContent =
    new Date().toLocaleDateString("nl-BE", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

  loadAgenda();
  setInterval(loadAgenda, REFRESH_INTERVAL);
});

// --------------------
// LOAD AGENDA
// --------------------
async function loadAgenda() {
  const cached = localStorage.getItem(CACHE_KEY);

  // Toon cache direct
  if (cached) {
    try {
      displayEvents(JSON.parse(cached), true);
    } catch {}
  }

  try {
    const response = await fetch(ICS_URL);
    if (!response.ok) throw new Error("Google Calendar niet bereikbaar");

    const data = await response.json();

    // Converteer items naar intern formaat
    const events = data.items.map(item => {
      return {
        summary: item.summary || "",
        location: item.location || "",
        start: item.start?.dateTime ? new Date(item.start.dateTime) : new Date(item.start?.date),
        end: item.end?.dateTime ? new Date(item.end.dateTime) : new Date(item.end?.date)
      };
    }).filter(e => e.start >= new Date()); // alleen toekomst

    // Deduplicatie: summary + start + end
    const seen = new Set();
    const uniqueEvents = events.filter(e => {
      const key = `${e.summary}|${e.start.toISOString()}|${e.end.toISOString()}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // Sorteer op startdatum
    uniqueEvents.sort((a,b) => a.start - b.start);

    const old = cached ? JSON.parse(cached) : null;
    if (JSON.stringify(uniqueEvents) !== JSON.stringify(old)) {
      localStorage.setItem(CACHE_KEY, JSON.stringify(uniqueEvents));
      displayEvents(uniqueEvents, false);
    }

  } catch (err) {
    console.error("Agenda error:", err);
    if (!cached) {
      document.getElementById("agenda-loading").classList.add("hidden");
      const el = document.getElementById("agenda-error");
      el.textContent = "Kan agenda niet laden…";
      el.classList.remove("hidden");
    }
  }
}

// --------------------
// DISPLAY EVENTS
// --------------------
function displayEvents(events, fromCache) {
  if (!fromCache) document.getElementById("agenda-loading").classList.add("hidden");

  const container = document.getElementById("agenda");
  container.innerHTML = "";

  if (!events.length) {
    container.innerHTML = "<p>Geen aankomende evenementen.</p>";
    return;
  }

  events.forEach(ev => {
    const start = ev.start;
    const end   = ev.end;

    const dateStr = start.toLocaleDateString("nl-BE", { weekday:"short", day:"2-digit", month:"short" });
    const timeStr = start.toLocaleTimeString("nl-BE", { hour:"2-digit", minute:"2-digit" }) +
                    " – " +
                    end.toLocaleTimeString("nl-BE", { hour:"2-digit", minute:"2-digit" });

    const div = document.createElement("div");
    div.className = "agenda-item";
    div.innerHTML = `
      <div class="agenda-title">${ev.summary}</div>
      <div class="agenda-datetime">${dateStr}, ${timeStr}</div>
      ${ev.location ? `<div class="agenda-location">${ev.location}</div>` : ""}
    `;

    container.appendChild(div);
  });
}
</script>

</body>
</html>

