<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Voertuigen</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>

<style>
/* --- Kalenderstijl --- */
#reservations {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.day-card {
  background: #f4f4f4;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.day-card h2 {
  font-size: 1.5em;
  margin-bottom: 10px;
  color: #0077cc;
}

.event-card {
  border-radius: 8px;
  background: #fff;
  padding: 10px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.event-card div {
  margin-bottom: 3px;
}

.event-card div span {
  font-weight: bold;
}
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo" alt="Brandweer Herentals">
    </div>
    <div class="header-right">
      <div class="header-greeting">Welkom</div>
      <div class="header-name" id="userName"></div>
      <div class="header-datetime" id="datetime"></div>
    </div>
  </header>

  <div class="content">
    <a href="index.html" class="backlink"><span class="arrow">‚Üê</span> Terug</a>

    <h2>üìÖ Weekoverzicht Voertuigenreservaties</h2>
    <div id="reservations"></div>
  </div>
</div>

<script>
/* -------------------- GEBRUIKER -------------------- */
const currentUser = localStorage.getItem("userName") || "Onbekend";
document.getElementById("userName").textContent = currentUser;

/* -------------------- DATETIME -------------------- */
setInterval(() => {
  document.getElementById("datetime").textContent = new Date().toLocaleString("nl-BE");
}, 1000);

/* -------------------- FIREBASE INIT -------------------- */
const firebaseConfig = {
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
console.log("‚úÖ Firebase klaar voor agenda");

/* -------------------- GOOGLE API INIT -------------------- */
function initGapi() {
  gapi.load('client', async () => {
    await gapi.client.init({
      apiKey: 'AIzaSyDLOdqVeA-SSjSN-0RtzDP4R451nqov0lE', // <--- vervang met jouw API key
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
    });
    console.log("‚úÖ Google API klaar");
    loadGoogleEvents();
  });
}

/* -------------------- LAAD GOOGLE AGENDA EVENTS -------------------- */
async function loadGoogleEvents() {
  try {
    const calendarId = 'df2fa36fb8ea4044f8276cf20d9922d6c350e7f7604bb5ad4a53521324f78727@group.calendar.google.com';
    const now = new Date().toISOString();
    const resp = await gapi.client.calendar.events.list({
      calendarId,
      timeMin: now,
      showDeleted: false,
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 50
    });
    const events = resp.result.items || [];
    renderAll(reservationsFirebase, events); // combine Firebase + Google
  } catch(err) {
    console.error("‚ö†Ô∏è Fout bij Google Calendar laden:", err);
  }
}

/* -------------------- FIREBASE LIVE DATA -------------------- */
let reservationsFirebase = [];
db.ref("reservations").on("value", snapshot => {
  const data = snapshot.val() || {};
  reservationsFirebase = Object.keys(data)
      .map(key => ({ id: key, ...data[key] }))
      .filter(r => r.status === "Goedgekeurd" && new Date(r.to) >= new Date());
  if(typeof gapi !== 'undefined' && gapi.client) loadGoogleEvents();
});

/* -------------------- RENDER FUNCTIE -------------------- */
function renderAll(firebaseRes, googleEvents) {
  const wrap = document.getElementById("reservations");
  wrap.innerHTML = "";

  // Combineer en groepeer per datum
  const combined = [];

  // Firebase events
  firebaseRes.forEach(r => {
    combined.push({
      type: 'firebase',
      date: new Date(r.from),
      title: r.vehicle,
      from: new Date(r.from),
      to: new Date(r.to),
      purpose: r.purpose,
      persons: r.persons,
      user: r.user
    });
  });

  // Google Calendar events
  googleEvents.forEach(e => {
    combined.push({
      type: 'google',
      date: new Date(e.start.dateTime || e.start.date),
      title: e.summary || 'Geen titel',
      from: new Date(e.start.dateTime || e.start.date),
      to: new Date(e.end.dateTime || e.end.date),
      purpose: e.description || '',
      persons: '-',
      user: e.organizer?.displayName || 'Extern'
    });
  });

  // Sorteer alles op starttijd
  combined.sort((a,b) => a.from - b.from);

  // Groepeer per datum
  const grouped = {};
  combined.forEach(ev => {
    const dayKey = ev.from.toLocaleDateString("nl-BE");
    if(!grouped[dayKey]) grouped[dayKey] = [];
    grouped[dayKey].push(ev);
  });

  // Render per dag
  Object.keys(grouped).forEach(date => {
    const dayCard = document.createElement("div");
    dayCard.className = "day-card";
    dayCard.innerHTML = `<h2>${date}</h2>`;
    grouped[date].forEach(ev => {
      const card = document.createElement("div");
      card.className = "event-card";
      card.innerHTML = `
        <div><span>Voertuig:</span> ${ev.title}</div>
        <div><span>Tijd:</span> ${ev.from.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${ev.to.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
        <div><span>Doel:</span> ${ev.purpose}</div>
        <div><span>Personen:</span> ${ev.persons}</div>
        <div><span>Door:</span> ${ev.user}</div>
      `;
      dayCard.appendChild(card);
    });
    wrap.appendChild(dayCard);
  });
}

/* -------------------- START GOOGLE API -------------------- */
initGapi();
</script>

</body>
</html>
