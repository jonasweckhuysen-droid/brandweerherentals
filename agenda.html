<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals — Portal</title>
<link rel="manifest" href="/brandweerherentals/manifest.json">
<meta name="theme-color" content="#c71f1f">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container" role="application" aria-label="Fire Crew Herentals portal">
    <header>
      <div class="logo" aria-hidden="true">BWH</div>
      <div>
        <h1>Agenda</h1>
        <p>Brandweer Kalender</p>
      </div>
    </header>
    <main class="content">
      <a href="/brandweerherentals/" class="back">← Terug naar start</a>
      <div id="agendaList">Laden…</div>
    </main>
    <footer>
      <div class="small">Versie 1.4 —</div>
      <div class="small">Laatste update: <span id="today"></span></div>
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Vandaag tonen in footer
      document.getElementById("today").textContent = new Date().toLocaleDateString("nl-BE", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

      const ICS_URL = "agenda.php"; // jouw PHP-proxy
      const CACHE_KEY = "agenda-cache-v2";

      function parseICSDatetime(str) {
        if (/^\d{8}$/.test(str)) {
          const y = parseInt(str.slice(0,4),10);
          const m = parseInt(str.slice(4,6),10) - 1;
          const d = parseInt(str.slice(6,8),10);
          return { date: new Date(y,m,d), allDay:true };
        } else if (/^\d{8}T\d{6}Z$/.test(str)) {
          const y = parseInt(str.slice(0,4),10);
          const m = parseInt(str.slice(4,6),10) - 1;
          const d = parseInt(str.slice(6,8),10);
          const h = parseInt(str.slice(9,11),10);
          const min = parseInt(str.slice(11,13),10);
          const s = parseInt(str.slice(13,15),10);
          return { date: new Date(Date.UTC(y,m,d,h,min,s)), allDay:false };
        } else {
          return { date: new Date(str), allDay:false };
        }
      }

      function parseICS(data) {
        const lines = data.split(/\r?\n/);
        const events = [];
        let current = null;

        lines.forEach(line => {
          if (line.startsWith("BEGIN:VEVENT")) current = {};
          else if (line.startsWith("END:VEVENT")) { if(current) events.push(current); current=null; }
          else if(current) {
            if (line.startsWith("SUMMARY:")) current.summary = line.replace("SUMMARY:","");
            else if (line.startsWith("DTSTART")) current.start = parseICSDatetime(line.split(":")[1]);
            else if (line.startsWith("DTEND")) current.end = parseICSDatetime(line.split(":")[1]);
            else if (line.startsWith("LOCATION:")) current.location = line.replace("LOCATION:","");
            else if (line.startsWith("DESCRIPTION:")) current.desc = line.replace("DESCRIPTION:","");
          }
        });

        const now = new Date();
        return events.filter(ev => ev.start && (ev.start.date >= now || ev.start.allDay))
                     .sort((a,b) => a.start.date - b.start.date);
      }

      function formatDate(ev) {
        if (ev.start.allDay) {
          return ev.start.date.toLocaleDateString("nl-BE", { weekday:"short", day:"2-digit", month:"short" }) + " (Hele dag)";
        } else {
          return ev.start.date.toLocaleDateString("nl-BE", { weekday:"short", day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
        }
      }

      function renderAgenda(txt) {
        const list = document.getElementById("agendaList");
        const events = parseICS(txt);

        if (!events.length) {
          list.innerHTML = "<p>Geen aankomende evenementen.</p>";
          return;
        }

        list.innerHTML = "";
        events.forEach(ev => {
          const el = document.createElement("div");
          el.className = "event";
          el.innerHTML = `
            <div class="event-date">${formatDate(ev)}</div>
            <div class="event-title">${ev.summary}</div>
            <div class="event-desc">${ev.location || ev.desc || ""}</div>
          `;
          list.appendChild(el);
        });
      }

      async function showCachedAgenda() {
        if('caches' in window){
          const cache = await caches.open(CACHE_KEY);
          const cached = await cache.match(ICS_URL);
          if(cached){
            const txt = await cached.text();
            renderAgenda(txt);
          }
        }
      }

      async function updateAgenda() {
        try {
          const res = await fetch(ICS_URL, { cache: "no-store" });
          if(res.ok){
            const txt = await res.text();
            renderAgenda(txt);
            const cache = await caches.open(CACHE_KEY);
            cache.put(ICS_URL, new Response(txt));
          } else {
            document.getElementById("agendaList").textContent = "Kan agenda niet laden.";
          }
        } catch(err){
          console.warn("Kon agenda niet verversen:", err);
          document.getElementById("agendaList").textContent = "Kan agenda niet laden.";
        }
      }

      showCachedAgenda();
      updateAgenda();
      setInterval(updateAgenda, 15*60*1000); // elke 15 min
    });
  </script>
</body>
</html>

