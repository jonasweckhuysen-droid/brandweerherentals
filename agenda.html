<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<div class="container">

  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo" alt="Brandweer Herentals">
    </div>
    <div class="header-right">
      <div class="header-greeting">Welkom</div>
      <div class="header-name" id="userName"></div>
      <div class="header-datetime" id="datetime"></div>
    </div>
  </header>

  <div class="content">
    <a href="index.html" class="backlink"><span class="arrow">‚Üê</span> Terug</a>
    <h2>üìÖ Agenda</h2>
    <div id="agenda" class="agenda-list"></div>
  </div>
</div>

<script>
/* -------------------- GEBRUIKER -------------------- */
const currentUser = localStorage.getItem("userName") || "Onbekend";
document.getElementById("userName").textContent = currentUser;

/* -------------------- ADMIN CHECK -------------------- */
const admins = ["Jonas Weckhuysen","Patrick Van Hove","Danny Van den Bergh"];
const isAdmin = admins.includes(currentUser);

/* -------------------- DATETIME -------------------- */
setInterval(() => {
  document.getElementById("datetime").textContent = new Date().toLocaleString("nl-BE");
}, 1000);

/* -------------------- FIREBASE INIT -------------------- */
const firebaseConfig = {
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
console.log("‚úÖ Firebase klaar");

/* -------------------- GOOGLE CALENDAR CONFIG -------------------- */
const GOOGLE_API_KEY = "AIzaSyDLOdqVeA-SSjSN-0RtzDP4R451nqov0lE"; // je Google API key
const VEHICLE_CALENDAR_ID = "primary"; // of een aparte kalender ID
const IMPORT_CALENDAR_ID = "df2fa36fb8ea4044f8276cf20d9922d6c350e7f7604bb5ad4a53521324f78727@group.calendar.google.com";

/* -------------------- LOAD GOOGLE CALENDAR EVENTS -------------------- */
async function loadGoogleCalendar() {
  const now = new Date();
  const startOfYear = new Date(now.getFullYear(),0,1).toISOString();
  const endOfYear = new Date(now.getFullYear(),11,31,23,59,59).toISOString();

  try {
    const res = await fetch(
      `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(IMPORT_CALENDAR_ID)}/events?key=${GOOGLE_API_KEY}&timeMin=${startOfYear}&timeMax=${endOfYear}&singleEvents=true&orderBy=startTime`
    );
    const data = await res.json();
    const events = data.items || [];
    renderEvents(events);
  } catch(err){
    console.error("‚ö†Ô∏è Fout bij laden Google Calendar:", err);
  }
}

/* -------------------- RENDER FUNCTIE -------------------- */
function renderEvents(events) {
  const wrap = document.getElementById("agenda");
  wrap.innerHTML = "";

  // Sorteer op datum
  events.sort((a,b) => new Date(a.start.dateTime||a.start.date) - new Date(b.start.dateTime||b.start.date));

  events.forEach(e => {
    const start = e.start.dateTime || e.start.date;
    const end = e.end.dateTime || e.end.date;

    const card = document.createElement("div");
    card.className = "card agenda-event";
    card.innerHTML = `
      <div class="card-header">
        üìÖ ${new Date(start).toLocaleDateString("nl-BE")}
      </div>
      <div class="card-body">
        <div><strong>${e.summary}</strong></div>
        <div>${start.includes("T") ? new Date(start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ""} - ${end.includes("T") ? new Date(end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ""}</div>
      </div>
    `;
    wrap.appendChild(card);
  });
}

/* -------------------- LOAD VEHICLE RESERVATIONS -------------------- */
db.ref("reservations").on("value", snapshot => {
  const data = snapshot.val() || {};
  const reservations = Object.keys(data)
      .map(key => ({ id: key, ...data[key] }))
      .filter(r => r.status === "Goedgekeurd") // Alleen goedgekeurde tonen
      .filter(r => new Date(r.to) >= new Date()); // Alleen toekomstige
  renderVehicleReservations(reservations);
});

/* -------------------- RENDER VEHICLE RESERVATIONS -------------------- */
function renderVehicleReservations(reservations) {
  const wrap = document.getElementById("agenda");

  reservations.forEach(r => {
    const card = document.createElement("div");
    card.className = "card vehicle-event";
    card.innerHTML = `
      <div class="card-header">
        üöí ${new Date(r.from).toLocaleDateString("nl-BE")}
      </div>
      <div class="card-body">
        <div><strong>${r.vehicle}</strong></div>
        <div>${new Date(r.from).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${new Date(r.to).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
        <div>Doel: ${r.purpose}</div>
        <div>Personen: ${r.persons}</div>
        <div>Door: ${r.user}</div>
      </div>
    `;
    wrap.appendChild(card);
  });
}

/* -------------------- INIT -------------------- */
loadGoogleCalendar();
</script>

<style>
.container{max-width:900px;margin:auto;padding:10px;font-family:sans-serif;}
.header-logo{height:50px;}
.header-right{float:right;text-align:right;}
.header-datetime{font-size:0.85em;color:#555;}
.content{margin-top:20px;}
.backlink{display:inline-block;margin-bottom:15px;text-decoration:none;color:#333;font-weight:bold;}
.card{border-radius:8px;padding:10px;margin-bottom:15px;background:#f8f8f8;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.card-header{font-weight:bold;margin-bottom:5px;}
.card-body{margin-left:5px;}
.agenda-event{background:#e0f7fa;}
.vehicle-event{background:#fff3e0;border-left:5px solid #ff9800;}
</style>

</body>
</html>
