<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voertuigenreservatie</title>
<link rel="stylesheet" href="style.css">
<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<div class="container">

  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo" alt="Brandweer Herentals">
    </div>
    <div class="header-right">
      <div class="header-greeting">Welkom</div>
      <div class="header-name" id="userName"></div>
      <div class="header-datetime" id="datetime"></div>
    </div>
  </header>

  <div class="content">
    <a href="index.html" class="backlink"><span class="arrow">â†</span> Terug</a>

    <h2>ğŸš’ Voertuigenreservatie</h2>

    <div class="card">
      <div class="card-header"><h3>Nieuwe aanvraag</h3></div>
      <div class="card-body">
        <label>Voertuig</label>
        <select id="vehicle">
          <option>Caddy S542</option>
          <option>Galaxy S541</option>
          <option>Personeelsbus S545</option>
          <option>Camionette L543</option>
        </select>

        <label>Van</label>
        <input type="datetime-local" id="from">

        <label>Tot</label>
        <input type="datetime-local" id="to">

        <label>Doeleinde</label>
        <input type="text" id="purpose">

        <label>Aantal personen</label>
        <input type="number" id="persons" min="1">

        <button class="call-btn" onclick="submitReservation()">Aanvraag indienen</button>
      </div>
    </div>

    <h2>ğŸ“… Reservaties</h2>
    <div id="reservations" class="grid"></div>
  </div>

</div>

<script>
/* -------------------- GEBRUIKER -------------------- */
const currentUser = localStorage.getItem("userName") || "Onbekend";
document.getElementById("userName").textContent = currentUser;

const admins = ["Jonas Weckhuysen","Patrick Van Hove","Danny Van den Bergh"];
const isAdmin = admins.includes(currentUser);

/* -------------------- DATETIME -------------------- */
setInterval(()=>{
  document.getElementById("datetime").textContent = new Date().toLocaleString("nl-BE");
},1000);

/* -------------------- DATA -------------------- */
let reservations = JSON.parse(localStorage.getItem("reservations")) || [];

/* -------------------- GOOGLE API -------------------- */
let gapiInited = false;
let gapiAuthInstance = null;
const CALENDAR_ID = 'primary';
function initGapi(){
    gapi.load('client:auth2', async ()=>{
        await gapi.client.init({
            apiKey: 'AIzaSyDLOdqVeA-SSjSN-0RtzDP4R451nqov0lE',
            clientId: '440406636112-36khnms08f1bjkol1aqsl6ded5pj39jk.apps.googleusercontent.com',
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            scope: "https://www.googleapis.com/auth/calendar"
        });
        gapiAuthInstance = gapi.auth2.getAuthInstance();
        gapiInited = true;
        console.log("âœ… gapi klaar");
        fetchEventsFromGoogle(); // haal meteen Google events bij init
    });
}
initGapi();

async function googleSignIn() {
    if(!gapiInited) return alert("Google API nog niet geladen");
    if(!gapiAuthInstance.isSignedIn.get()) await gapiAuthInstance.signIn();
    console.log("Ingelogd als:", gapiAuthInstance.currentUser.get().getBasicProfile().getName());
}

async function pushToGoogleCalendar(res){
    if(!gapiInited) return console.warn("gapi nog niet klaar");
    await googleSignIn();
    const event = {
        summary: res.vehicle,
        description: `Doel: ${res.purpose}\nAantal personen: ${res.persons}\nAanvrager: ${res.user}`,
        start: {dateTime: new Date(res.from).toISOString()},
        end: {dateTime: new Date(res.to).toISOString()},
        reminders: {useDefault:true}
    };
    try{
        const result = await gapi.client.calendar.events.insert({calendarId:CALENDAR_ID, resource:event});
        console.log("âœ” Naar Google Calendar:", res.vehicle, result);
    }catch(err){console.error("âš ï¸ Fout push:", err);}
}

async function fetchEventsFromGoogle(){
    if(!gapiInited) return;
    await googleSignIn();
    try{
        const now = new Date().toISOString();
        const response = await gapi.client.calendar.events.list({
            calendarId: CALENDAR_ID,
            timeMin: now,
            maxResults: 50,
            singleEvents: true,
            orderBy: "startTime"
        });
        const googleEvents = response.result.items.map(ev=>({
            id: ev.id,
            vehicle: ev.summary,
            from: ev.start.dateTime || ev.start.date,
            to: ev.end.dateTime || ev.end.date,
            purpose: ev.description,
            user: "Google Calendar",
            status: "Goedgekeurd"
        }));

        // merge Google events met lokale app-reservaties
        googleEvents.forEach(ge=>{
            if(!reservations.some(r=>r.id===ge.id)) reservations.push(ge);
        });
        save();
        render();
    }catch(err){console.error("âš ï¸ Fout bij ophalen Google:", err);}
}

/* -------------------- SUBMIT -------------------- */
function submitReservation(){
    const r = {
        id: Date.now(),
        user: currentUser,
        vehicle: vehicle.value,
        from: from.value,
        to: to.value,
        purpose: purpose.value,
        persons: persons.value,
        status: "In afwachting"
    };
    reservations.push(r);
    save();
    render();
    // velden leegmaken
    vehicle.selectedIndex=0; from.value=""; to.value=""; purpose.value=""; persons.value="";
}

/* -------------------- SAVE -------------------- */
function save(){ localStorage.setItem("reservations", JSON.stringify(reservations)); }

/* -------------------- APPROVE / DELETE -------------------- */
function approve(id,status){
    reservations = reservations.map(r=>r.id===id?{...r,status}:r);
    save();
    render();
    if(status==="Goedgekeurd"){
        const approved = reservations.find(r=>r.id===id);
        if(approved && !approved.googlePushed){ // enkel pushen als nog niet in Google
            pushToGoogleCalendar(approved);
            approved.googlePushed = true; save();
        }
    }
}

function removeReservation(id){
    if(!confirm("Weet je zeker dat je deze reservatie wil verwijderen?")) return;
    reservations = reservations.filter(r=>r.id!==id);
    save();
    render();
}

/* -------------------- VERLOPEN -------------------- */
function removeExpired(){
    const now=new Date();
    reservations = reservations.filter(r=>new Date(r.to)>=now);
    save();
}
setInterval(removeExpired,60000);

/* -------------------- RENDER -------------------- */
function render(){
    const wrap = document.getElementById("reservations");
    wrap.innerHTML="";
    reservations.forEach(r=>{
        if(!isAdmin && r.user!==currentUser && r.user!=="Google Calendar") return;
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <div class="card-header"><h3>${r.vehicle}</h3></div>
          <div class="card-body">
            <div><strong>Van:</strong> ${r.from}</div>
            <div><strong>Tot:</strong> ${r.to}</div>
            <div><strong>Door:</strong> ${r.user}</div>
            <div><strong>Doel:</strong> ${r.purpose}</div>
            <div><strong>Personen:</strong> ${r.persons}</div>
            <div><strong>Status:</strong> ${r.status}</div>
            ${
              isAdmin? `
                ${r.status==="In afwachting"?`<button class="call-btn" onclick="approve(${r.id},'Goedgekeurd')">âœ” Goedkeuren</button>
                                                  <button class="call-btn" style="background:#444" onclick="approve(${r.id},'Afgekeurd')">âœ– Afkeuren</button>`:""}
                <button class="call-btn" style="background:#900;" onclick="removeReservation(${r.id})">ğŸ—‘ Verwijderen</button>`:""}
          </div>`;
        wrap.appendChild(card);
    });
}

/* -------------------- INIT -------------------- */
render();
removeExpired();
setInterval(fetchEventsFromGoogle, 5*60*1000); // elke 5 minuten Google events sync
</script>

</body>
</html>
