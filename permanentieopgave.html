<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Permanentie Kalender</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
/* Container en header */
.container{max-width:1000px;margin:auto;padding:10px;font-family:sans-serif;}
.header-logo{height:50px;}
.header-right{float:right;text-align:right;}
.header-datetime{font-size:0.85em;color:#fff;}
#appHeader{background:#d32f2f;padding:10px 15px;border-radius:8px 8px 0 0;color:#fff;}
.content{margin-top:20px;}
.backlink{display:inline-block;margin-bottom:15px;text-decoration:none;color:#333;font-weight:bold;}

/* Kalender */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;}
.day{padding:10px;border-radius:8px;min-height:80px;background:#f2f2f2;cursor:pointer;position:relative;}
.day.unavailable{background:#ddd;cursor:not-allowed;}
.day.today{border:2px solid #d32f2f;}
.day-header{font-weight:bold;margin-bottom:5px;text-align:center;}

/* Team in dag */
.team-member{display:block;margin:2px 0;padding:2px 4px;border-radius:4px;color:#fff;font-size:0.85em;}
.chauffeur{background:#FF9800;}
.bevelvoerder{background:#4CAF50;}
.brandweermannen{background:#f44336;}
.stagiair{background:#9C27B0;}

/* Tooltip */
.day-tooltip{position:absolute;top:5px;right:5px;font-size:0.7em;color:#555;}

/* Buttons */
.call-btn{margin-top:5px;padding:5px 10px;background:#2196f3;color:#fff;border:none;border-radius:5px;cursor:pointer;}
.call-btn:hover{background:#1976d2;}
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo" alt="Brandweer Herentals">
    </div>
    <div class="header-right">
      <div class="header-greeting">Welkom</div>
      <div class="header-name" id="userName"></div>
      <div class="header-datetime" id="datetime"></div>
    </div>
  </header>

  <div class="content">
    <a href="index.html" class="backlink"><span class="arrow">â†</span> Terug</a>

    <h2>ğŸ§‘â€ğŸš’ Permanentie Kalender</h2>
    <p>Geef je beschikbaarheid door van de 16e van deze maand tot de 15e van volgende maand voor de daaropvolgende maand. Rollen: ğŸš— Chauffeur, ğŸ§‘â€âœˆï¸ Bevelvoerder, ğŸ”¥ Brandweerman, ğŸ‘¶ Stagiair.</p>

    <div id="calendar" class="calendar"></div>
    <div id="roleSelection" style="margin-top:15px;display:none;">
      <label>Rol:</label>
      <select id="roleSelect">
        <option value="chauffeur">ğŸš— Chauffeur</option>
        <option value="bevelvoerder">ğŸ§‘â€âœˆï¸ Bevelvoerder</option>
        <option value="brandweerman">ğŸ”¥ Brandweerman</option>
        <option value="stagiair">ğŸ‘¶ Stagiair</option>
      </select>
      <button class="call-btn" id="submitRoleBtn">Doorgeven</button>
    </div>

  </div>
</div>

<script>
/* -------------------- GEBRUIKER -------------------- */
const currentUser = localStorage.getItem("userName") || "Onbekend";
document.getElementById("userName").textContent = currentUser;

/* -------------------- ADMIN CHECK -------------------- */
const admins = ["Jonas Weckhuysen","Patrick Van Hove","Danny Van den Bergh"];
const isAdmin = admins.includes(currentUser);

/* -------------------- DATETIME -------------------- */
setInterval(() => {
  document.getElementById("datetime").textContent = new Date().toLocaleString("nl-BE");
}, 1000);

/* -------------------- FIREBASE INIT -------------------- */
const firebaseConfig = {
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
console.log("âœ… Firebase klaar");

/* -------------------- FEESTDAGEN & SCHOOLVAKANTIES -------------------- */
const belgischeFeestdagen = ["2026-01-01","2026-04-06","2026-05-01","2026-05-14","2026-05-25","2026-07-21","2026-08-15","2026-11-01","2026-11-11","2026-12-25"];
const schoolVakanties = [
  {start:"2026-02-16",end:"2026-02-20"},
  {start:"2026-04-06",end:"2026-04-17"},
  {start:"2026-07-01",end:"2026-08-31"},
  {start:"2026-10-26",end:"2026-10-30"},
  {start:"2026-12-21",end:"2027-01-03"}
];

function isAvailable(dateStr){
  const date = new Date(dateStr);
  const day = date.getDay();
  if(day === 0 || day === 6) return false;
  if(belgischeFeestdagen.includes(dateStr)) return false;
  for(const v of schoolVakanties){
    if(dateStr >= v.start && dateStr <= v.end) return false;
  }
  return true;
}

/* -------------------- KALENDER MAKEN -------------------- */
const calendarDiv = document.getElementById("calendar");
let today = new Date();
let startDate = new Date(today.getFullYear(), today.getMonth(),16);
let endDate = new Date(today.getFullYear(), today.getMonth()+1,15);

function pad(n){return n<10?'0'+n:n;}
function renderCalendar(){
  calendarDiv.innerHTML='';
  let current = new Date(startDate);
  while(current<=endDate){
    const dateStr = `${current.getFullYear()}-${pad(current.getMonth()+1)}-${pad(current.getDate())}`;
    const dayDiv = document.createElement('div');
    dayDiv.className='day';
    if(!isAvailable(dateStr)) dayDiv.classList.add('unavailable');
    if(current.toDateString()===today.toDateString()) dayDiv.classList.add('today');
    dayDiv.dataset.date=dateStr;
    dayDiv.innerHTML=`<div class="day-header">${current.getDate()}/${current.getMonth()+1}</div><div class="team-members" id="day-${dateStr}"></div><div class="day-tooltip" id="tooltip-${dateStr}"></div>`;
    calendarDiv.appendChild(dayDiv);

    if(isAvailable(dateStr)){
      dayDiv.addEventListener('click', ()=>{
        selectedDate=dateStr;
        document.getElementById('roleSelection').style.display='block';
      });
    }
    current.setDate(current.getDate()+1);
  }
}
renderCalendar();

/* -------------------- BESCHIKBAARHEID DOORGEVEN -------------------- */
let selectedDate=null;
document.getElementById('submitRoleBtn').addEventListener('click', ()=>{
  const role=document.getElementById('roleSelect').value;
  if(!selectedDate) return;
  const r={user: currentUser, role, timestamp:Date.now()};
  db.ref('permanencies/'+selectedDate).push(r)
    .then(()=>{alert('Rol doorgegeven'); selectedDate=null; document.getElementById('roleSelection').style.display='none';})
    .catch(err=>console.error(err));
});

/* -------------------- TEAMS EN TOOLTIPS RENDEREN -------------------- */
function renderTeamsAndTooltips(){
  db.ref('permanencies').on('value', snap=>{
    const data = snap.val() || {};
    for(const dateStr in data){
      const dayDiv=document.getElementById(`day-${dateStr}`);
      const tooltipDiv=document.getElementById(`tooltip-${dateStr}`);
      if(dayDiv){
        dayDiv.innerHTML=''; tooltipDiv.innerHTML='';
        let counts={chauffeur:0,bevelvoerder:0,brandweerman:0,stagiair:0};
        Object.values(data[dateStr]).forEach(p=>{
          const span=document.createElement('span');
          span.className='team-member '+p.role;
          span.textContent=p.user;
          dayDiv.appendChild(span);
          counts[p.role]++;
        });
        tooltipDiv.textContent=`Chauffeur:${counts.chauffeur} | Bevelvoerder:${counts.bevelvoerder} | Brandweermannen:${counts.brandweerman} | Stagiair:${counts.stagiair}`;
        if(isAdmin){
          const btn=document.createElement('button');
          btn.textContent='âœï¸ Wijzig';
          btn.className='call-btn';
          btn.onclick=()=>editDay(dateStr);
          dayDiv.appendChild(btn);
        }
      }
    }
  });
}
renderTeamsAndTooltips();

/* -------------------- ADMIN WIJZIGEN -------------------- */
function editDay(dateStr){
  db.ref('permanencies/'+dateStr).once('value').then(snap=>{
    const users = snap.val() || {};
    Object.keys(users).forEach(k=>{
      const u=users[k];
      let newName = prompt(`Nieuwe naam voor ${u.role}`, u.user);
      if(newName) db.ref(`permanencies/${dateStr}/${k}/user`).set(newName);
    });
  });
}

/* -------------------- AUTOMATISCHE PLANNING MET VOORRANG -------------------- */
function autoScheduleMonth(){
  db.ref('permanencies').once('value').then(snap=>{
    const data = snap.val() || {};
    let userCounts={}; // tel wie al hoe vaak
    db.ref('teams').once('value').then(tsnap=>{
      const tdata=tsnap.val()||{};
      Object.values(tdata).forEach(team=>{
        Object.values(team).forEach(val=>{
          if(Array.isArray(val)) val.forEach(u=>userCounts[u]=(userCounts[u]||0)+1);
          else userCounts[val]=(userCounts[val]||0)+1;
        });
      });

      for(const dateStr in data){
        const avail = data[dateStr];
        let roles={chauffeur:[],bevelvoerder:[],brandweerman:[],stagiair:[]};
        Object.values(avail).forEach(p=>roles[p.role].push(p.user));
        if(roles.chauffeur.length>=1 && roles.bevelvoerder.length>=1 && roles.brandweerman.length>=4 && roles.stagiair.length>=1){
          const team={
            chauffeur:roles.chauffeur.sort((a,b)=> (userCounts[a]||0)-(userCounts[b]||0))[0],
            bevelvoerder:roles.bevelvoerder.sort((a,b)=> (userCounts[a]||0)-(userCounts[b]||0))[0],
            brandweermannen:shuffleArray(roles.brandweerman).slice(0,4),
            stagiair:roles.stagiair.sort((a,b)=> (userCounts[a]||0)-(userCounts[b]||0))[0]
          };
          db.ref('teams/'+dateStr).set(team);
        }
      }
    });
  });
}
function shuffleArray(arr){return arr.sort(()=>Math.random()-0.5);}
autoScheduleMonth();

</script>

</body>
</html>
