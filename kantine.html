<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals ‚Äî Kantine</title>
<link rel="manifest" href="/brandweerherentals/manifest.json">
<meta name="theme-color" content="#c71f1f">
<link rel="stylesheet" href="/brandweerherentals/kantine.css">
<style>
.product-card {
  border: 2px solid #ccc;
  border-radius: 12px;
  padding: 12px;
  text-align: center;
  margin: 8px;
  display: inline-block;
  width: 120px;
  transition: all 0.2s;
}
.product-card.low-stock {
  border-color: #c71f1f;
  background: #ffe6e6;
}
.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 8px;
}
.controls button {
  background: var(--red);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-weight: 600;
  margin: 0 4px;
}
.controls button:hover { background: #a10f0f; }
.cart { margin-top: 20px; }
.cart li { margin-bottom: 4px; }

/* Overlay styling binnen app-kader */
.overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.overlay-content {
  background: #fff;
  padding: 24px;
  border-radius: 12px;
  max-width: 360px;
  width: 90%;
  text-align: center;
}
.overlay-content h2 { margin-bottom: 16px; }
.payment-buttons { display: flex; justify-content: space-between; margin: 12px 0; }
.payment-buttons button {
  flex: 1;
  margin: 0 6px;
  padding: 10px 0;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
}
#payPayconiq { background: #1a9e39; }
#payCash { background: #c71f1f; }
#closeOverlay { margin-top: 16px; background: #555; }
#qrCode img { width: 200px; height: 200px; margin: 12px 0; }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header id="appHeader">
    <div class="header-left">
      <img src="/brandweerherentals/icons/logo.png" alt="Brandweer Herentals" class="header-logo">
    </div>
    <div class="header-right">
      <div id="greeting" class="header-greeting"></div>
      <div id="datetime" class="header-datetime"></div>
      <div id="ploegOfWeek" class="header-ploeg"></div>
    </div>
  </header>

  <main class="content">
    <a href="/brandweerherentals/index.html" class="backlink"><span class="arrow">‚Üê</span> Terug naar Start</a>

    <div id="productGrid"></div>

    <div class="cart">
      <h2>üßæ Jouw bestelling</h2>
      <ul id="cartList"><li>Geen producten geselecteerd.</li></ul>
      <div id="cartTotal"></div>
      <button id="confirmOrder" disabled>Bevestig bestelling</button>
    </div>
  </main>
</div>

<!-- Overlay voor betaling -->
<div id="paymentOverlay" class="overlay" style="display:none;">
  <div class="overlay-content">
    <h2>üí≥ Kies betaalmethode</h2>
    <p id="overlayTotal" class="bold"></p>
    <div class="payment-buttons">
      <button id="payPayconiq">QR / Payconiq</button>
      <button id="payCash">Cash</button>
    </div>
    <div id="qrSection"><div id="qrCode"></div></div>
    <div id="noticeMsg"></div>
    <button id="closeOverlay">Sluiten</button>
  </div>
</div>

<script>
// ---------- Load stock ----------
let cart = {};
let producten = JSON.parse(localStorage.getItem("kantine_stock") || "[]");
if (!producten.length) {
  producten = [
    { name: "Pintje", stock: 20, min: 5 },
    { name: "Cola", stock: 12, min: 5 },
    { name: "Fanta", stock: 15, min: 3 },
    { name: "Water", stock: 20, min: 5 },
    { name: "Koffie", stock: 10, min: 2 },
    { name: "Chips", stock: 7, min: 3 }
  ];
  localStorage.setItem("kantine_stock", JSON.stringify(producten));
}

const grid = document.getElementById("productGrid");
const cartList = document.getElementById("cartList");
const cartTotal = document.getElementById("cartTotal");
const confirmBtn = document.getElementById("confirmOrder");

// Render producten
function renderProducts(){
  grid.innerHTML = "";
  producten.forEach(prod=>{
    const card = document.createElement("div");
    card.className = "product-card";
    if(prod.stock <= prod.min) card.classList.add("low-stock");
    card.innerHTML = `
      <h3>${prod.name}</h3>
      <p>‚Ç¨${prod.prijs ? prod.prijs.toFixed(2) : "1.5"}</p>
      <p>Stock: ${prod.stock}</p>
      <div class="controls">
        <button class="minus">‚àí</button>
        <span aria-live="polite">${cart[prod.name] || 0}</span>
        <button class="plus">+</button>
      </div>
    `;
    const plus = card.querySelector(".plus");
    const minus = card.querySelector(".minus");
    const countEl = card.querySelector("span");

    plus.addEventListener("click", ()=>{
      if(prod.stock <= (cart[prod.name]||0)) return;
      cart[prod.name] = (cart[prod.name]||0) + 1;
      countEl.textContent = cart[prod.name];
      updateCart();
    });
    minus.addEventListener("click", ()=>{
      if(!cart[prod.name]) return;
      cart[prod.name]--;
      if(cart[prod.name]<=0){ delete cart[prod.name]; countEl.textContent=0; }
      else countEl.textContent = cart[prod.name];
      updateCart();
    });

    grid.appendChild(card);
  });
}

// Update cart
function updateCart(){
  cartList.innerHTML = "";
  let totaal = 0;
  const entries = Object.entries(cart);
  if(!entries.length){ cartList.innerHTML="<li>Geen producten geselecteerd.</li>"; cartTotal.textContent=""; confirmBtn.disabled=true; return; }

  entries.forEach(([naam,aantal])=>{
    const prod = producten.find(p=>p.name===naam);
    const prijs = prod.prijs||1.5;
    totaal += prijs*aantal;
    const li = document.createElement("li");
    li.innerHTML = `${aantal} √ó ${naam} <span>‚Ç¨${(prijs*aantal).toFixed(2)}</span>`;
    cartList.appendChild(li);
  });

  const totalLi = document.createElement("li");
  totalLi.innerHTML = `<strong>Totaal</strong> <span><strong>‚Ç¨${totaal.toFixed(2)}</strong></span>`;
  cartList.appendChild(totalLi);

  cartTotal.textContent = `Totaal te betalen: ‚Ç¨${totaal.toFixed(2)}`;
  confirmBtn.disabled = false;
}

// ---------- Betaling overlay ----------
const overlay = document.getElementById("paymentOverlay");
const overlayTotal = document.getElementById("overlayTotal");
const qrCodeDiv = document.getElementById("qrCode");
const noticeMsg = document.getElementById("noticeMsg");
const IBAN = "BE12345678901234";
const mededeling = "Kantine Brandweer Herentals";

function buildEpcPayload(iban, amount, message){
  const amountStr = parseFloat(amount).toFixed(2);
  const lines = ["BCD","002","1","SCT","",""+iban.replace(/\s+/g,''),"",amountStr,"EUR",message||""];
  return lines.join("\n");
}

function showOverlay(){
  const totaal = Object.entries(cart).reduce((s,[naam,aantal])=>{
    const p = producten.find(x=>x.name===naam); 
    return s + ((p.prijs||1.5)*aantal);
  },0);
  overlayTotal.textContent = `üí∞ Totaal: ‚Ç¨${totaal.toFixed(2)}`;
  
  // QR-code automatisch genereren
  const payload = buildEpcPayload(IBAN, totaal.toFixed(2), mededeling);
  const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(payload);
  qrCodeDiv.innerHTML = `<img src="${qrUrl}" alt="QR Betaling">`;

  noticeMsg.innerHTML = "";
  overlay.style.display = "flex";
}

confirmBtn.addEventListener("click", showOverlay);

document.getElementById("payPayconiq").addEventListener("click", ()=>{
  noticeMsg.innerHTML = `üì≤ Scan de QR-code via je bankapp of Payconiq`;
  completePayment();
});

document.getElementById("payCash").addEventListener("click", ()=>{
  noticeMsg.innerHTML = `üí∂ Contante betaling ontvangen`;
  completePayment();
});

document.getElementById("closeOverlay").addEventListener("click", ()=>{
  overlay.style.display = "none";
  noticeMsg.innerHTML="";
});

function completePayment(){
  const timestamp = new Date().toLocaleString('nl-BE');
  const order = { tijd: timestamp, items: {...cart} };
  const existing = JSON.parse(localStorage.getItem("kantine_bestellingen")||"[]");
  existing.push(order);
  localStorage.setItem("kantine_bestellingen", JSON.stringify(existing));

  // Update stock
  Object.entries(cart).forEach(([naam,aantal])=>{
    const prod = producten.find(p=>p.name===naam);
    if(prod) prod.stock -= aantal;
  });
  localStorage.setItem("kantine_stock", JSON.stringify(producten));

  cart = {};
  renderProducts();
  updateCart();
  confirmBtn.disabled = true;
}

window.addEventListener("storage", (event)=>{
  if(event.key==="kantine_stock"){
    producten = JSON.parse(event.newValue);
    renderProducts();
    updateCart();
  }
});

renderProducts();
updateCart();
</script>

<script src="/brandweerherentals/header.js"></script>
</body>
</html>
