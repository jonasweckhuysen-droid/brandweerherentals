<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kantine â€” Brandweer Herentals</title>
<link rel="stylesheet" href="/brandweerherentals/kantine.css">
<link rel="manifest" href="/brandweerherentals/manifest.json">
<meta name="theme-color" content="#c71f1f">
</head>
<body>
<div class="container">
  <header>Kantine â€” Bestelling</header>

  <main>
    <div class="product-grid" id="productGrid"></div>

    <div class="cart" id="cartSection">
      <h2>ðŸ§¾ Jouw bestelling</h2>
      <ul id="cartList"></ul>
      <button id="confirmOrder">Bevestig bestelling</button>
    </div>
  </main>

  <footer>Brandweer Herentals â€” Kantinebeheer</footer>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbyJ-dqNiQ7Z187DIidfJahBFNB5RQcWFDQdZIxGKyzS3_Xf831SdsRSFyDxPFLQcTE/exec";

// Productenlijst
let producten = [
  { naam: "Pintje", prijs: 1.5, img: "/brandweerherentals/icons/drinks/beer.png", stock: 0 },
  { naam: "Cola", prijs: 1.8, img: "/brandweerherentals/icons/drinks/cola.png", stock: 0 },
  { naam: "Fanta", prijs: 1.8, img: "/brandweerherentals/icons/drinks/fanta.png", stock: 0 },
  { naam: "Water", prijs: 1.0, img: "/brandweerherentals/icons/drinks/water.png", stock: 0 },
  { naam: "Koffie", prijs: 1.2, img: "/brandweerherentals/icons/drinks/coffee.png", stock: 0 },
  { naam: "Chips", prijs: 1.5, img: "/brandweerherentals/icons/drinks/chips.png", stock: 0 }
];

const grid = document.getElementById("productGrid");
const cartList = document.getElementById("cartList");
const confirmBtn = document.getElementById("confirmOrder");
let cart = {};

// ðŸ§ƒ Haal actuele stock op bij laden
async function fetchStock() {
  try {
    const res = await fetch(webAppUrl);
    const data = await res.json();
    // Stock updaten in producten array
    producten.forEach(p => {
      const prod = data.find(d => d.name === p.naam);
      p.stock = prod ? prod.stock : 0;
    });
    renderProducts();
  } catch(err) {
    console.error("Kan stock niet laden:", err);
  }
}

// ðŸ§ƒ Producten tonen
function renderProducts() {
  grid.innerHTML = "";
  producten.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <img src="${p.img}" alt="${p.naam}">
      <h3>${p.naam}</h3>
      <p>â‚¬${p.prijs.toFixed(2)} | Voorraad: ${p.stock}</p>
      <div class="controls">
        <button class="minus">âˆ’</button>
        <span>0</span>
        <button class="plus">+</button>
      </div>
    `;

    const countEl = card.querySelector("span");
    const minusBtn = card.querySelector(".minus");
    const plusBtn = card.querySelector(".plus");

    plusBtn.onclick = () => {
      if (cart[p.naam] >= p.stock) return alert("Niet genoeg voorraad!");
      cart[p.naam] = (cart[p.naam] || 0) + 1;
      updateCart();
    };

    minusBtn.onclick = () => {
      if (cart[p.naam]) {
        cart[p.naam]--;
        if (cart[p.naam] <= 0) delete cart[p.naam];
        updateCart();
      }
    };

    grid.appendChild(card);
  });
}

// ðŸ§¾ Winkelmandje bijwerken
function updateCart() {
  cartList.innerHTML = "";
  let totaal = 0;

  for (const [naam, aantal] of Object.entries(cart)) {
    const product = producten.find(p => p.naam === naam);
    const subtotaal = product.prijs * aantal;
    totaal += subtotaal;

    const li = document.createElement("li");
    li.textContent = `${aantal} Ã— ${naam}`;
    const price = document.createElement("span");
    price.textContent = `â‚¬${subtotaal.toFixed(2)}`;
    li.appendChild(price);
    cartList.appendChild(li);
  }

  if (totaal === 0) {
    cartList.innerHTML = "<li>Geen producten geselecteerd.</li>";
    confirmBtn.disabled = true;
  } else {
    const totalLi = document.createElement("li");
    totalLi.innerHTML = `<strong>Totaal</strong><span><strong>â‚¬${totaal.toFixed(2)}</strong></span>`;
    cartList.appendChild(totalLi);
    confirmBtn.disabled = false;
  }

  // Teller in kaarten updaten
  document.querySelectorAll(".product-card").forEach(card => {
    const name = card.querySelector("h3").textContent;
    const countEl = card.querySelector("span");
    countEl.textContent = cart[name] || 0;
  });
}

// ðŸ’¾ Bestelling bevestigen
confirmBtn.addEventListener("click", async () => {
  if (Object.keys(cart).length === 0) return;

  const naam = prompt("Vul je naam in:");
  if (!naam) return alert("Naam verplicht!");

  try {
    for (const [product, quantity] of Object.entries(cart)) {
      const response = await fetch(webAppUrl, {
        method: "POST",
        body: JSON.stringify({ name: naam, product, quantity }),
        headers: { "Content-Type": "application/json" }
      });
      const result = await response.json();
      if (result.status !== "ok") throw new Error(result.message || "Fout bij verzenden");
    }

    // Betaalopties
    const keuze = confirm("Wil je betalen via Payconiq (OK) of Cash (Annuleren)?");
    if (keuze) {
      window.open("https://payconiq.com", "_blank");
    } else {
      alert("ðŸ’¶ Betaling geregistreerd als contant.");
    }

    cart = {};
    await fetchStock(); // Stock bijwerken
    updateCart();
  } catch(err) {
    alert("Fout bij bestelling: " + err.message);
    console.error(err);
  }
});

// Init
fetchStock();
</script>
</body>
</html>
