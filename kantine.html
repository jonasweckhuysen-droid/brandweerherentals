<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals ‚Äî Portal</title>
<link rel="manifest" href="/brandweerherentals/manifest.json">
<meta name="theme-color" content="#c71f1f">

<!-- Link naar de externe CSS -->
<link rel="stylesheet" href="/brandweerherentals/kantine.css">
</head>
<body>
<div class="container" role="application" aria-label="Fire Crew Herentals portal">
  <!-- -----------------------------------
       HEADER
  ------------------------------------ -->
  <header id="appHeader">
  <div class="header-left">
    <div id="greeting" class="header-name"></div>
  </div>

  <div class="header-right">
    <div id="datetime" class="header-datetime"></div>
    <div id="ploegOfWeek" class="header-ploeg"></div>
  </div>
</header>

  <main class="content">
    <a href="/brandweerherentals/" class="backlink">
  <span class="arrow">‚Üê</span> Terug naar start
</a>

    <div class="product-grid" id="productGrid" aria-live="polite"></div>

    <div class="cart" id="cartSection" aria-live="polite">
      <h2>üßæ Jouw bestelling</h2>
      <ul id="cartList"><li>Geen producten geselecteerd.</li></ul>
      <div id="cartTotal"></div>
      <button id="confirmOrder" disabled>Bevestig bestelling</button>
      <div class="small-muted">Na bevestiging kies je de betaalmethode. De winkelkar wordt pas gewist nadat je betaalmethode gekozen hebt.</div>
    </div>
  </main>

  <footer>Brandweer Herentals ‚Äî Kantinebeheer</footer>
</div>

<!-- Overlay voor betaling -->
<div id="paymentOverlay" class="overlay" style="display:none;">
  <div class="overlay-content" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <h2 id="payTitle">üí≥ Kies betaalmethode</h2>
    <p id="overlayTotal" class="bold"></p>

    <div class="payment-buttons">
      <button id="payPayconiq" class="btn payconiq">Payconiq</button>
      <button id="payCash" class="btn cash">Cash</button>
      <button id="payTransfer" class="btn transfer">Overschrijving</button>
    </div>

    <div id="qrSection">
      <div id="qrCode" aria-hidden="false"></div>
    </div>

    <div id="noticeMsg"></div>

    <div class="overlay-close">
      <button id="closeOverlay" class="btn close">Sluiten</button>
    </div>
  </div>
</div>

<script>
// ---------- Producten & cart logic ----------
const producten = [
  { naam: "Pintje", prijs: 1.5, img: "/brandweerherentals/icons/drinks/beer.png" },
  { naam: "Cola", prijs: 1.8, img: "/brandweerherentals/icons/drinks/cola.png" },
  { naam: "Fanta", prijs: 1.8, img: "/brandweerherentals/icons/drinks/fanta.png" },
  { naam: "Water", prijs: 1.0, img: "/brandweerherentals/icons/drinks/water.png" },
  { naam: "Koffie", prijs: 1.2, img: "/brandweerherentals/icons/drinks/coffee.png" },
  { naam: "Chips", prijs: 1.5, img: "/brandweerherentals/icons/drinks/chips.png" }
];

const grid = document.getElementById("productGrid");
const cartList = document.getElementById("cartList");
const cartTotal = document.getElementById("cartTotal");
const confirmBtn = document.getElementById("confirmOrder");
let cart = {}; 

function renderProducts(){
  grid.innerHTML = "";
  producten.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <img src="${p.img}" alt="${p.naam}" class="drink-icon">
      <h3>${p.naam}</h3>
      <p>‚Ç¨${p.prijs.toFixed(2)}</p>
      <div class="controls" aria-label="${p.naam} keuze">
        <button class="minus" aria-label="verwijder √©√©n ${p.naam}">‚àí</button>
        <span aria-live="polite">0</span>
        <button class="plus" aria-label="voeg √©√©n ${p.naam} toe">+</button>
      </div>
    `;
    const plus = card.querySelector(".plus");
    const minus = card.querySelector(".minus");
    const countEl = card.querySelector("span");

    plus.addEventListener("click", () => {
      cart[p.naam] = (cart[p.naam] || 0) + 1;
      countEl.textContent = cart[p.naam];
      updateCart();
    });
    minus.addEventListener("click", () => {
      if (!cart[p.naam]) return;
      cart[p.naam]--;
      if (cart[p.naam] <= 0) {
        delete cart[p.naam];
        countEl.textContent = 0;
      } else {
        countEl.textContent = cart[p.naam];
      }
      updateCart();
    });

    grid.appendChild(card);
  });
}

function updateCart(){
  cartList.innerHTML = "";
  let totaal = 0;
  const entries = Object.entries(cart);
  if (!entries.length) {
    cartList.innerHTML = "<li>Geen producten geselecteerd.</li>";
    cartTotal.textContent = "";
    confirmBtn.disabled = true;
    return;
  }
  for (const [naam,aantal] of entries) {
    const p = producten.find(x => x.naam === naam);
    const subtotaal = p.prijs * aantal;
    totaal += subtotaal;
    const li = document.createElement("li");
    li.innerHTML = `${aantal} √ó ${naam} <span>‚Ç¨${subtotaal.toFixed(2)}</span>`;
    cartList.appendChild(li);
  }
  const totalLi = document.createElement("li");
  totalLi.innerHTML = `<strong>Totaal</strong> <span><strong>‚Ç¨${totaal.toFixed(2)}</strong></span>`;
  cartList.appendChild(totalLi);

  cartTotal.textContent = `Totaal te betalen: ‚Ç¨${totaal.toFixed(2)}`;
  confirmBtn.disabled = false;
}

// ---------- Payment overlay & QR logic ----------
const overlay = document.getElementById("paymentOverlay");
const overlayTotal = document.getElementById("overlayTotal");
const qrCodeDiv = document.getElementById("qrCode");
const noticeMsg = document.getElementById("noticeMsg");
const IBAN = "BE12345678901234";
const mededeling = "Kantine Brandweer Herentals";

function buildEpcPayload(iban, amount, message){
  const amountStr = parseFloat(amount).toFixed(2);
  const lines = [
    "BCD","002","1","SCT","",""+iban.replace(/\s+/g,''),"",amountStr,"EUR",message||""
  ];
  return lines.join("\n");
}

function showOverlayAndQR(){
  const totaal = Object.entries(cart).reduce((s,[naam,aantal])=>{
    const p = producten.find(x=>x.naam===naam);
    return s + (p.prijs * aantal);
  },0);
  overlayTotal.textContent = `üí∞ Totaal te betalen: ‚Ç¨${totaal.toFixed(2)}`;

  const payload = buildEpcPayload(IBAN, totaal.toFixed(2), mededeling);
  const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(payload);

  qrCodeDiv.innerHTML = `<img src="${qrUrl}" alt="QR Betaling (overschrijving)"><div class="small-muted">Scan met je bank-app om de overschrijving te starten</div>`;
  noticeMsg.innerHTML = "";
  overlay.style.display = "flex";
}

confirmBtn.addEventListener("click", () => {
  if (!Object.keys(cart).length) return;
  showOverlayAndQR();
});

document.getElementById("payPayconiq").addEventListener("click", () => {
  const totaal = overlayTotal.textContent;
  noticeMsg.innerHTML = `<div class="notice">üì≤ Open je Payconiq-app en scan/of volg de instructies om <strong>${totaal}</strong> te betalen.</div>`;
  clearCartAfterPayment();
});

document.getElementById("payCash").addEventListener("click", () => {
  const totaal = overlayTotal.textContent;
  noticeMsg.innerHTML = `<div class="notice">üí∂ Contant ontvangen: <strong>${totaal}</strong>. Bedankt!</div>`;
  clearCartAfterPayment();
});

document.getElementById("payTransfer").addEventListener("click", () => {
  const totaal = overlayTotal.textContent;
  noticeMsg.innerHTML = `<div class="notice">üè¶ Maak een overschrijving naar:<br><strong>IBAN:</strong> ${IBAN}<br><strong>Mededeling:</strong> ${mededeling}<br>${totaal}</div>`;
  clearCartAfterPayment();
});

document.getElementById("closeOverlay").addEventListener("click", () => {
  overlay.style.display = "none";
  noticeMsg.innerHTML = "";
});

function clearCartAfterPayment(){
  const timestamp = new Date().toLocaleString('nl-BE');
  const order = { tijd: timestamp, items: {...cart} };
  const existing = JSON.parse(localStorage.getItem("kantine_bestellingen") || "[]");
  existing.push(order);
  localStorage.setItem("kantine_bestellingen", JSON.stringify(existing));

  cart = {};
  renderProducts();
  updateCart();
  confirmBtn.disabled = true;
}

renderProducts();
updateCart();
</script>

<!-- Header.js zorgt voor greeting, datetime & ploeg -->
<script src="/brandweerherentals/header.js"></script>
</body>
</html>


