<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Duiker â€” Brandweer Herentals</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      background: #111;
      color: white;
    }
    .duik-card {
      background: #222;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 5px solid #0b5ed7;
    }
    .duiker-rij {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #333;
    }
    .duiker-naam {
      font-weight: bold;
    }
    .duiker-functie {
      font-size: 0.9rem;
      opacity: 0.7;
    }
    .status-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      min-width: 70px;
    }
    .status-onbekend { background: #7f8c8d; color: white; }
    .status-yes { background: #2ecc71; color: white; }
    .status-no { background: #e74c3c; color: white; }
  </style>
</head>
<body>
<div class="container">

  <header id="appHeader">
    <div class="header-left">
      <img src="/brandweerherentals/icons/logo.png" class="header-logo" alt="">
    </div>
    <div class="header-right">
      <div id="greeting" class="header-greeting"></div>
      <div id="datetime" class="header-datetime"></div>
      <div id="ploegOfWeek" class="header-ploeg"></div>
    </div>
  </header>

  <main>
    <h2>ğŸ¤¿ Duikagenda & Aanwezigheid</h2>
    <p>De keren en oefeningen worden geladen uit Excel. Zet hier je aanwezigheid.</p>
    <div id="duikAgendaContainer"></div>

    <a href="index.html" class="backlink">â† Terug naar menu</a>
  </main>

  <footer><div>Brandweer Herentals</div></footer>
</div>

<script src="/brandweerherentals/header.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- SheetJS to read Excel in browser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.2/dist/xlsx.full.min.js"></script>

<script>
  // =====================================
  // Firebase initialisatie
  // =====================================
  const firebaseConfig = {
    apiKey: "AIzaSyAUkFsXiJ7MOIDFfC0AUk9DiT_BPIHzfEE",
    authDomain: "post-herentals.firebaseapp.com",
    databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "post-herentals",
    storageBucket: "post-herentals.firebasestorage.app",
    messagingSenderId: "762725561089",
    appId: "1:762725561089:web:38c46cccf44d624252100",
    measurementId: "G-C2FWECFEQX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // =====================================
  // Duikteam - vaste lijst
  // =====================================
  const duikers = [
    { naam: "Bart Boons", functie: "Duiker" },
    { naam: "Jef Leysen", functie: "Duiker" },
    { naam: "Wannes Verhegge", functie: "Duiker" },
    { naam: "Jonas Weckhuysen", functie: "Duiker" },
    { naam: "Danny Van den Bergh", functie: "Assistent" },
    { naam: "Patrick Van Hove", functie: "Assistent" },
    { naam: "Alain Leemans", functie: "Assistent" },
    { naam: "Kurt Cools", functie: "Assistent" },
    { naam: "Pedro Wallyn", functie: "Assistent" }
  ];

  // =====================================
  // Functie om Excel te laden & parsen
  // =====================================
  async function fetchExcelAndParse() {
    // raw-URL van je bestand op GitHub
    const url = "https://raw.githubusercontent.com/jonasweckhuysen-droid/brandweerherentals/main/Duikoefeningen.xlsx";

    const resp = await fetch(url);
    const blob = await resp.blob();
    const arrayBuffer = await blob.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);

    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
    return json;
  }

  // =====================================
  // Genereren van agenda + aanwezigheidsâ€UI
  // =====================================
  async function initAgenda() {
    const raw = await fetchExcelAndParse();
    // raw is array van objecten, elk object = rij in Excel

    // We veronderstellen dat Excel kolommen bevat als:
    // Datum | Uur | Oefening | Locatie (of een combinatie)
    // Pas onderstaande veldnamen aan volgens jouw Excel-kopteksten

    const kontainer = document.getElementById("duikAgendaContainer");
    kontainer.innerHTML = "";

    raw.forEach(entry => {
      const datum = entry["Datum"];
      const uur   = entry["Uur"];
      const oef   = entry["Oefening"] || entry["Oefening / Omschrijving"] || "";
      const loc   = entry["Locatie"] || "";

      const dateISO = `${datum}T${uur}`;

      const dateKey = datum.replace(/\//g,"-") + "_" + uur.replace(/:/g,"-");

      const card = document.createElement("div");
      card.className = "duik-card";

      const h3 = document.createElement("h3");
      h3.textContent = `ğŸ“… ${datum} â€” ${uur}`;
      card.appendChild(h3);

      const info = document.createElement("div");
      info.style.marginBottom = "10px";
      info.innerHTML =
        (loc ? `ğŸ“ <strong>Locatie:</strong> ${loc}<br>` : "") +
        (oef ? `ğŸ“ <strong>Oefening:</strong> ${oef}<br>` : "");
      card.appendChild(info);

      // lijst met duikers
      duikers.forEach(d => {
        const row = document.createElement("div");
        row.className = "duiker-rij";

        const nameSpan = document.createElement("span");
        nameSpan.innerHTML = `<span class="duiker-naam">${d.naam}</span> <span class="duiker-functie">(${d.functie})</span>`;

        const btn = document.createElement("button");
        btn.className = "status-btn status-onbekend";
        btn.innerText = "â€¦";

        const dbRef = db.ref(`duikAanwezig/${dateKey}/${d.naam}`);

        // live luisteren
        dbRef.on("value", snap => {
          const v = snap.val();
          if (v === true) {
            btn.className = "status-btn status-yes";
            btn.innerText = "Aanwezig";
          } else if (v === false) {
            btn.className = "status-btn status-no";
            btn.innerText = "Afwezig";
          } else {
            btn.className = "status-btn status-onbekend";
            btn.innerText = "â€¦";
          }
        });

        btn.onclick = () => {
          // wissel status
          dbRef.get().then(snap=>{
            const v = snap.val();
            dbRef.set(v === true ? false : true);
          });
        };

        row.appendChild(nameSpan);
        row.appendChild(btn);
        card.appendChild(row);
      });

      kontainer.appendChild(card);
    });
  }

  // Start
  initAgenda().catch(err => {
    console.error("Fout bij laden duikagenda:", err);
    const c = document.getElementById("duikAgendaContainer");
    c.innerHTML = "<div style='color:#ccc; padding:20px;'>Kon duikagenda niet laden.</div>";
  });

</script>

</body>
</html>
