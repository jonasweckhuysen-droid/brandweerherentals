<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals ‚Äî Defectmeldingen status</title>

<style>
body {
  background:#ffffff;
  font-family:Arial,sans-serif;
  margin:0;
}

header {
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 15px;
  background:#c71f1f;
  color:#fff;
}

.header-logo {
  height:48px;
}

main {
  padding-bottom:20px;
}

.page-title {
  color:#111;
  text-align:center;
  margin:15px 0 5px;
  font-size:1.4rem;
  font-weight:700;
}

.teller {
  text-align:center;
  margin-bottom:15px;
  font-weight:600;
  color:#333;
}

.backlink {
  display:inline-block;
  margin:10px 15px;
  text-decoration:none;
  color:#c71f1f;
  font-weight:600;
}

#meldingenContainer {
  display:flex;
  flex-direction:column;
  gap:16px;
  padding:0 15px;
}

.melding {
  background:#fff;
  padding:16px;
  border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  border:1px solid #eee;
  opacity:0;
  transform:translateY(10px);
  animation:fadeIn .4s forwards;
}

@keyframes fadeIn {
  to {
    opacity:1;
    transform:translateY(0);
  }
}

.row {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:10px;
}

.item {
  flex:1;
  min-width:140px;
}

.label {
  font-size:.78rem;
  color:#777;
  margin-bottom:2px;
}

.value {
  font-size:.95rem;
  font-weight:600;
  color:#111;
}

.status {
  display:inline-block;
  padding:5px 14px;
  border-radius:20px;
  font-weight:600;
  font-size:.8rem;
  text-align:center;
}

.status.Gemeld {background:#d6e4ff;color:#1c3faa;}
.status.Bezig {background:#fff3cd;color:#856404;}
.status.Afgewerkt {background:#d4edda;color:#155724;}
.status.Onbekend {background:#eee;color:#333;}

footer {
  text-align:center;
  padding:10px;
  font-size:0.75rem;
  color:#666;
}
</style>
</head>

<body>

<header>
  <img src="/brandweerherentals/icons/logo.png" class="header-logo"/>
  <strong>Brandweer Herentals</strong>
</header>

<a href="defectmelding.html" class="backlink">‚Üê Terug naar melding</a>

<h2 class="page-title">üìä Defectmeldingen - Live status</h2>
<div id="teller" class="teller">Laden‚Ä¶</div>

<div id="meldingenContainer"></div>

<footer>Fire Crew Herentals ‚Äì Live systeem</footer>

<script>
const SHEET_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPU8cIbYtxm6jjiDUPJxufcOkCbHrKR1RJGYcjIVzfPxXvUMm-jiRpq0XMcFbiyg/pub?gid=0&single=true&output=csv&ts=" + Date.now();

const container = document.getElementById("meldingenContainer");
const teller = document.getElementById("teller");

const REFRESH_INTERVAL = 30000;

// ======================
// CSV PARSE
// ======================
function parseCSV(text) {
  const delimiter = text.includes(";") ? ";" : ",";
  const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
  return rows.map(line => line.split(delimiter).map(c => c.replace(/^"|"$/g,"").trim()));
}

// ======================
// DATUM PARSE
// ======================
function parseDate(str) {
  if(!str) return new Date(0);
  const parts = str.split("/");
  if (parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
  const d = new Date(str);
  return isNaN(d) ? new Date(0) : d;
}

// ======================
// HEADER FINDER
// ======================
function findIndex(headers, keyword) {
  return headers.findIndex(h => h.toLowerCase().includes(keyword.toLowerCase()));
}

// ======================
// RENDER
// ======================
function renderMeldingen(data){

  data.sort((a,b)=>b.datumObj - a.datumObj);
  container.innerHTML = "";
  teller.textContent = `Totaal: ${data.length} meldingen`;

  if(data.length === 0){
    container.innerHTML = "<i>Geen meldingen gevonden</i>";
    return;
  }

  data.forEach(m=>{
    const div = document.createElement("div");
    div.className = "melding";

    div.innerHTML = `
      <div class="row">
        <div class="item">
          <div class="label">üë§ Naam</div>
          <div class="value">${m.naam}</div>
        </div>
        <div class="item">
          <div class="label">üìÖ Datum</div>
          <div class="value">${m.datum}</div>
        </div>
      </div>

      <div class="row">
        <div class="item" style="flex:2">
          <div class="label">üõ†Ô∏è Defect</div>
          <div class="value">${m.omschrijving}</div>
        </div>
        <div class="item">
          <div class="label">Status</div>
          <span class="status ${m.statusClass}">${m.status}</span>
        </div>
      </div>
    `;

    container.appendChild(div);
  });
}

// ======================
// LOAD
// ======================
function loadMeldingen(){
  fetch(SHEET_URL, { cache: "no-store" })
    .then(r=>{
        if(!r.ok) throw new Error("HTTP "+r.status)
        return r.text()
    })
    .then(text=>{
        const rows = parseCSV(text);
        const headers = rows.shift().map(h => h.toLowerCase().trim());

        const naamIndex = findIndex(headers, "naam");
        const datumIndex = findIndex(headers, "datum");
        const omsIndex = findIndex(headers, "omschrijving");
        const statusIndex = findIndex(headers, "status");

        let meldingen = [];

        rows.forEach(r=>{
          const naam = r[naamIndex] || "/";
          const datum = r[datumIndex] || "/";
          const oms = r[omsIndex] || "/";
          const raw = (r[statusIndex] || "").toLowerCase();

          let status="Onbekend", statusClass="Onbekend";
          if(raw.includes("gemeld")) status="Gemeld",statusClass="Gemeld";
          if(raw.includes("bezig")||raw.includes("behandeling")) status="In behandeling",statusClass="Bezig";
          if(raw.includes("afgewerkt")||raw.includes("opgelost")) status="Afgewerkt",statusClass="Afgewerkt";

          if(!naam && !oms) return;

          meldingen.push({
            naam,
            datum,
            datumObj: parseDate(datum),
            omschrijving: oms,
            status,
            statusClass
          });
        });

        renderMeldingen(meldingen);
    })
    .catch(err=>{
      console.error(err);
      teller.textContent = "Verbinding tijdelijk niet beschikbaar...";
    });
}

loadMeldingen();
setInterval(loadMeldingen, REFRESH_INTERVAL);

</script>
</body>
</html>
