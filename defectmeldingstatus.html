<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals ‚Äî Defectmeldingen status</title>
<link rel="manifest" href="/brandweerherentals/manifest.json">
<meta name="theme-color" content="#c71f1f">
<link rel="stylesheet" href="style.css">

<style>
body { background: #f2f2f2; }
.page-title { color: #111; text-align: center; margin: 10px 0 5px; font-size: 1.6rem; font-weight: 700; }
.teller { text-align: center; margin-bottom: 20px; font-weight: 600; color: #333; }
.backlink { display:inline-block; margin: 10px 0 20px; text-decoration:none; color:#fff; font-weight:600; }
.backlink .arrow { margin-right:6px; }
#meldingenContainer { display: flex; flex-direction: column; gap: 16px; }
.melding { background: #fff; padding: 16px; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.12); border: 1px solid #eee; }
.row { display: flex; flex-wrap: wrap; margin-bottom: 10px; gap: 12px; }
.item { flex: 1; min-width: 140px; }
.label { font-size: 0.8rem; color: #888; margin-bottom: 3px; }
.value { font-size: 1rem; font-weight: 600; color: #111; white-space: normal; word-break: break-word; }
.status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; text-align: center; }
.status.Gemeld { background: #d6e4ff; color: #1c3faa; }
.status.Bezig { background: #fff3cd; color: #856404; }
.status.Afgewerkt { background: #d4edda; color: #155724; }
.status.Onbekend { background: #eee; color: #333; }
.loader { text-align: center; margin-top: 40px; font-style: italic; color: #777; }
</style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <header id="appHeader">
    <div class="header-left">
      <img src="/brandweerherentals/icons/logo.png" alt="Brandweer Herentals" class="header-logo">
    </div>
    <div class="header-right">
      <div id="greeting" class="header-greeting"></div>
      <div id="datetime" class="header-datetime"></div>
      <div id="ploegOfWeek" class="header-ploeg"></div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="content">
    <a href="defectmelding.html" class="backlink">
      <span class="arrow">‚Üê</span> Terug naar defectmelding
    </a>

    <h2 class="page-title">üìä Defectmeldingen ‚Äî Live status</h2>
    <div id="teller" class="teller">Bezig met laden...</div>
    <div id="meldingenContainer">
      <p class="loader">Meldingen worden geladen...</p>
    </div>
  </main>

  <footer>
    <div>Versie 1.2</div>
  </footer>
</div>

<script src="/brandweerherentals/header.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPU8cIbYtxm6jjiDUPJxufcOkCbHrKR1RJGYcjIVzfPxXvUMm-jiRpq0XMcFbiyg/pub?output=csv";
const container = document.getElementById("meldingenContainer");
const teller = document.getElementById("teller");
const CACHE_KEY = "cachedMeldingen";

// --- CSV parser ---
function parseCSV(text) {
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); // normalize
  const lines = text.split('\n');
  const rows = [];
  for(let line of lines){
    if(!line.trim()) continue;
    const row = [];
    let value = "";
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const char = line[i];
      const next = line[i+1];
      if(char === '"' && inQuotes && next === '"'){ value+='"'; i++; }
      else if(char === '"'){ inQuotes = !inQuotes; }
      else if((char===','||char===';') && !inQuotes){ row.push(value); value=""; }
      else{ value+=char; }
    }
    row.push(value);
    rows.push(row);
  }
  return rows;
}

// --- Datum parser dd/mm/yyyy ---
function parseDate(str){
  if(!str) return new Date(0);
  const parts = str.split("/");
  if(parts.length===3) return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
  const d = new Date(str);
  return isNaN(d) ? new Date(0) : d;
}

// --- Status mapping ---
const STATUS_MAP = {
  "gemeld": {status:"Gemeld", class:"Gemeld"},
  "bezig": {status:"In behandeling", class:"Bezig"},
  "behandeling": {status:"In behandeling", class:"Bezig"},
  "afgewerkt": {status:"Afgewerkt", class:"Afgewerkt"},
  "opgelost": {status:"Afgewerkt", class:"Afgewerkt"}
};

// --- Render functie ---
function renderMeldingen(data){
  data.sort((a,b)=> (b.datumObj||0) - (a.datumObj||0));
  container.innerHTML = "";
  teller.textContent = `Totaal: ${data.length} meldingen`;

  if(data.length===0){
    container.innerHTML = "<p class='loader'>Geen meldingen gevonden</p>";
    return;
  }

  data.forEach(m=>{
    const melding = document.createElement("div");
    melding.classList.add("melding");

    melding.innerHTML = `
      <div class="row">
        <div class="item">
          <div class="label">üë§ Naam</div>
          <div class="value">${m.naam||"/"}</div>
        </div>
        <div class="item">
          <div class="label">üìÖ Datum</div>
          <div class="value">${m.datum||"/"}</div>
        </div>
      </div>
      <div class="row">
        <div class="item" style="flex:2">
          <div class="label">üõ†Ô∏è Defect omschrijving</div>
          <div class="value">${m.omschrijving||"/"}</div>
        </div>
        <div class="item">
          <div class="label">üìå Status</div>
          <span class="status ${m.statusClass}">${m.status}</span>
        </div>
      </div>
    `;
    container.appendChild(melding);
  });
}

// --- Fetch + caching ---
function loadMeldingen(){
  container.innerHTML = "<p class='loader'>Meldingen worden geladen...</p>";
  fetch(SHEET_URL)
    .then(res=>res.text())
    .then(csvText=>{
      const rows = parseCSV(csvText);
      if(rows.length<2) throw new Error("Geen data gevonden");
      const headers = rows.shift();
      const getIndex = name=>headers.findIndex(h=>h.trim().toLowerCase()===name.toLowerCase());
      const naamIndex = getIndex("Naam");
      const datumIndex = getIndex("Datum");
      const omschrijvingIndex = getIndex("Defect omschrijving");
      const statusIndex = getIndex("Status");

      const meldingenData = [];
      rows.forEach(row=>{
        const naam = (row[naamIndex]||"").trim();
        const datum = (row[datumIndex]||"").trim();
        const omschrijving = (row[omschrijvingIndex]||"").trim();
        const statusRaw = (row[statusIndex]||"").trim();
        if(!naam&&!datum&&!omschrijving&&!statusRaw) return;

        let status="Onbekend", statusClass="Onbekend";
        const lower = statusRaw.toLowerCase();
        const match = Object.keys(STATUS_MAP).find(key=>lower.includes(key));
        if(match){ ({status,statusClass}=STATUS_MAP[match]); }

        meldingenData.push({naam, datum, datumObj:parseDate(datum), omschrijving, status, statusClass});
      });

      if(meldingenData.length>0){
        localStorage.setItem(CACHE_KEY, JSON.stringify(meldingenData));
        renderMeldingen(meldingenData);
      } else {
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached){
          console.warn("Geen nieuwe meldingen, toon cache.");
          renderMeldingen(JSON.parse(cached));
        } else {
          container.innerHTML="<p class='loader'>Geen meldingen gevonden</p>";
          teller.textContent="Geen meldingen";
        }
      }
    })
    .catch(err=>{
      console.error(err);
      const cached = localStorage.getItem(CACHE_KEY);
      if(cached){
        console.warn("Fout bij fetch, toon cache.");
        renderMeldingen(JSON.parse(cached));
      } else {
        container.innerHTML="<p class='loader' style='color:red;'>Fout bij het laden van de gegevens</p>";
        teller.textContent="Fout bij laden";
      }
    });
}

// Laad direct
loadMeldingen();
</script>

</body>
</html>
