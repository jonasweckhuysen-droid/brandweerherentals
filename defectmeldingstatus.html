<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals ‚Äî Defectmeldingen status</title>

<style>
body {
  background:#ffffff;
  font-family:Arial,sans-serif;
  margin:0;
  padding:0;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 15px;
  background:#c71f1f;
  color:#fff;
}

.header-logo {
  height:60px;
}

.page-title {
  color:#111;
  text-align:center;
  margin:10px 0 5px;
  font-size:1.5rem;
  font-weight:700;
}

.teller {
  text-align:center;
  margin-bottom:20px;
  font-weight:600;
  color:#333;
}

.backlink {
  display:inline-block;
  margin:10px 15px;
  text-decoration:none;
  color:#c71f1f;
  font-weight:600;
}

.backlink .arrow {
  margin-right:6px;
}

#meldingenContainer {
  display:flex;
  flex-direction:column;
  gap:16px;
  padding:0 15px 20px 15px;
}

.melding {
  background:#fff;
  padding:16px;
  border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  border:1px solid #eee;
  opacity:0;
  transform:translateY(10px);
  animation:fadeIn 0.4s forwards;
}

@keyframes fadeIn {
  to { opacity:1; transform:translateY(0); }
}

.row {
  display:flex;
  flex-wrap:wrap;
  margin-bottom:10px;
  gap:12px;
}

.item {
  flex:1;
  min-width:140px;
}

.label {
  font-size:0.8rem;
  color:#777;
  margin-bottom:3px;
}

.value {
  font-size:1rem;
  font-weight:600;
  color:#111;
  word-break:break-word;
}

.status {
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-weight:600;
  font-size:0.85rem;
  text-align:center;
}

.status.Gemeld {
  background:#d6e4ff;
  color:#1c3faa;
}

.status.Bezig {
  background:#fff3cd;
  color:#856404;
}

.status.Afgewerkt {
  background:#d4edda;
  color:#155724;
}

.status.Onbekend {
  background:#eee;
  color:#333;
}

.loader {
  text-align:center;
  margin-top:40px;
  font-style:italic;
  color:#777;
}

footer {
  text-align:center;
  padding:10px;
  font-size:0.8rem;
  color:#555;
}
</style>
</head>

<body>

<header>
  <img src="/brandweerherentals/icons/logo.png" class="header-logo" alt="Logo">
  <div>Brandweer Herentals</div>
</header>

<main>

  <a href="defectmelding.html" class="backlink">
    <span class="arrow">‚Üê</span> Terug naar defectmelding
  </a>

  <h2 class="page-title">üìä Defectmeldingen ‚Äî Live status</h2>

  <div id="teller" class="teller">Bezig met laden...</div>

  <div id="meldingenContainer">
    <p class="loader">Meldingen worden geladen...</p>
  </div>

</main>

<footer>Versie 1.3</footer>

<script>
// ‚úÖ CORRECTE & STABIELE CSV LINK
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPU8cIbYtxm6jjiDUPJxufcOkCbHrKR1RJGYcjIVzfPxXvUMm-jiRpq0XMcFbiyg/pub?gid=0&single=true&output=csv";

const container = document.getElementById("meldingenContainer");
const teller = document.getElementById("teller");

const REFRESH_INTERVAL = 30000; // 30 seconden

function parseCSV(text) {
  const rows = [], row = [];
  let inQuotes = false, value = "";

  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i+1];

    if (c === '"' && inQuotes && next === '"') {
      value += '"';
      i++;
    } 
    else if (c === '"') {
      inQuotes = !inQuotes;
    } 
    else if ((c === ',' || c === ';') && !inQuotes) {
      row.push(value);
      value = "";
    } 
    else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (value || row.length) {
        row.push(value);
        rows.push([...row]);
        row.length = 0;
        value = "";
      }
    } 
    else {
      value += c;
    }
  }

  if (value || row.length) {
    row.push(value);
    rows.push([...row]);
  }

  return rows;
}

function parseDate(str) {
  if (!str) return new Date(0);

  const parts = str.split("/");
  if (parts.length === 3) {
    return new Date(parts[2], parts[1] - 1, parts[0]);
  }

  const d = new Date(str);
  return isNaN(d) ? new Date(0) : d;
}

function renderMeldingen(data) {
  // ‚úÖ Nieuwste eerst
  data.sort((a, b) => b.datumObj - a.datumObj);

  container.innerHTML = "";
  teller.textContent = `Totaal: ${data.length} meldingen`;

  if (data.length === 0) {
    container.innerHTML = "<p class='loader'>Geen meldingen gevonden</p>";
    return;
  }

  data.forEach(m => {
    const melding = document.createElement("div");
    melding.classList.add("melding");

    melding.innerHTML = `
      <div class="row">
        <div class="item">
          <div class="label">üë§ Naam</div>
          <div class="value">${m.naam || "/"}</div>
        </div>
        <div class="item">
          <div class="label">üìÖ Datum</div>
          <div class="value">${m.datum || "/"}</div>
        </div>
      </div>

      <div class="row">
        <div class="item" style="flex:2">
          <div class="label">üõ†Ô∏è Defect omschrijving</div>
          <div class="value">${m.omschrijving || "/"}</div>
        </div>
        <div class="item">
          <div class="label">üìå Status</div>
          <span class="status ${m.statusClass}">${m.status}</span>
        </div>
      </div>
    `;

    container.appendChild(melding);
  });
}

function loadMeldingen(retries = 5, delay = 2000) {

  fetch(SHEET_URL, { cache: "no-store" }) // ‚úÖ anti-cache
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.text();
    })
    .then(csvText => {

      const rows = parseCSV(csvText);
      const headers = rows.shift();

      const getIndex = name =>
        headers.findIndex(h => h.trim().toLowerCase() === name.toLowerCase());

      const naamIndex = getIndex("Naam");
      const datumIndex = getIndex("Datum");
      const omschrijvingIndex = getIndex("Defect omschrijving");
      const statusIndex = getIndex("Status");

      const meldingenData = [];

      rows.forEach(row => {

        const naam = (row[naamIndex] || "").trim();
        const datum = (row[datumIndex] || "").trim();
        const omschrijving = (row[omschrijvingIndex] || "").trim();
        const statusRaw = (row[statusIndex] || "").trim();

        if (!naam && !datum && !omschrijving && !statusRaw) return;

        let status = "Onbekend";
        let statusClass = "Onbekend";

        const lower = statusRaw.toLowerCase();

        if (lower.includes("gemeld")) {
          status = "Gemeld";
          statusClass = "Gemeld";
        }
        else if (lower.includes("bezig") || lower.includes("behandeling")) {
          status = "In behandeling";
          statusClass = "Bezig";
        }
        else if (lower.includes("afgewerkt") || lower.includes("opgelost")) {
          status = "Afgewerkt";
          statusClass = "Afgewerkt";
        }

        meldingenData.push({
          naam,
          datum,
          datumObj: parseDate(datum),
          omschrijving,
          status,
          statusClass
        });
      });

      if (meldingenData.length === 0) {
        throw new Error("Geen data gevonden");
      }

      renderMeldingen(meldingenData);
    })
    .catch(err => {
      console.error(err);

      if (retries > 0) {
        teller.textContent = `Fout bij laden ‚Äî nieuwe poging over ${delay/1000}s...`;
        setTimeout(() => loadMeldingen(retries - 1, delay), delay);
      } else {
        container.innerHTML = "<p class='loader' style='color:red;'>Kan geen meldingen laden</p>";
        teller.textContent = "‚ùå Fout bij laden";
      }
    });
}

// Eerste laden
loadMeldingen();

// Automatisch verversen
setInterval(loadMeldingen, REFRESH_INTERVAL);

</script>

</body>
</html>
