<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chauffeur Oefenmomenten ‚Äî Brandweer Herentals</title>
<link rel="stylesheet" href="style.css">

<style>
body { margin:0; font-family: Arial, sans-serif; background:#f2f4f7; }
.container { max-width:900px; margin:0 auto 20px auto; background:#fff; border-radius:15px; box-shadow:0 6px 15px rgba(0,0,0,0.1); padding:0 20px 20px 20px; }
header#appHeader { display:flex; justify-content:space-between; align-items:center; background:#c62828; color:white; margin:-20px -20px 0 -20px; padding:15px 20px; border-radius:15px 15px 0 0; }
.header-left, .header-right { display:flex; align-items:center; }
.header-logo { height:50px; }
.header-greeting, .header-datetime, .header-ploeg { margin-left:10px; font-weight:bold; color:white; }
.backlink { text-decoration:none; font-weight:600; display:inline-block; margin:25px 0 20px 0; color:white; background:#c62828; padding:6px 12px; border-radius:8px; }
#searchInput { padding:10px 12px; border-radius:10px; border:1px solid #ccc; font-size:1rem; margin-bottom:20px; width:100%; }
.chauffeur-card { background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px; border-left:6px solid #c62828; }
.chauffeur-card h3 { display:flex; justify-content:space-between; align-items:center; }
.counter { font-size:0.9rem; color:#555; }
.vehicle { margin-top:10px; padding:10px; border:1px solid #eee; border-radius:12px; background:#fff; }
.veh-header { font-weight:bold; margin-bottom:8px; display:flex; align-items:center; }
.veh-header label { margin-right:8px; font-weight:bold; }
.exercise-list label { display:block; margin-bottom:4px; }
</style>
</head>
<body>

<div class="container">

<header id="appHeader">
  <div class="header-left">
    <img src="/brandweerherentals/icons/logo.png" alt="Brandweer Herentals" class="header-logo">
  </div>
  <div class="header-right">
    <div id="greeting" class="header-greeting"></div>
    <div id="datetime" class="header-datetime"></div>
    <div id="ploegOfWeek" class="header-ploeg"></div>
  </div>
</header>

<main>
  <a href="index.html" class="backlink">‚Üê Terug naar menu</a>
  <input type="text" id="searchInput" placeholder="Zoek op naam...">
  <div id="chauffeurContainer"></div>
</main>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-database-compat.js"></script>

<script>
// ===================== FIREBASE INITIALISATIE =====================
const firebaseConfig = {
  databaseURL: "https://bwhchauffeur-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ===================== TOEGANGSRECHTEN =====================
const loggedInUser = localStorage.getItem("userName") || "";
const admins = ["Patrick Van Hove","Alain Leemans","Jonas Weckhuysen","Danny Van Den Bergh"];
const isAdmin = admins.includes(loggedInUser);

// ===================== DATA =====================
const chauffeurs = {
  "Dries Boven": [], "Robin Buyens": [], "Bart Cools": [], "Kurt Cools": [], "Gianni Cornelis": [],
  "Roel Dekort": [], "Rik Goris": [], "Kris Hoeylaerts": [], "Philippe Hoeylaerts": [], "Vincent Leemans": [],
  "Bart Leten": [], "Steven Maes": [], "Liese Meyskens": [], "Rutger Moons": [], "Sven Van Buren": [],
  "Jakke Van den Broeck": [], "Kris Van Looveren": [], "No√´l Van Roy": [], "Joris Van Vracem": [],
  "Cristoph Verhaegen": [], "Robbe Vervecken": [], "Steven Vervloet": []
};

const oefenmomenten = {
  "B541":[1,2,3,4,5,6], "L544":[1,2,3,4], "L549":[1,2,3,4,5], "A545":[1,2,3,4,5,6],
  "D541":[1,2,3], "M545":[1,2,3,4], "T545":[1,2,3,4,5,6], "H541":[1,2,3,4,5,6],
  "A541":[1,2,3,4,5,6], "Containers":[1]
};

// ===================== GROEPEN =====================
const chauffeursVolgorde = Object.keys(chauffeurs);
const mid = Math.ceil(chauffeursVolgorde.length/2);
const groep1 = chauffeursVolgorde.slice(0,mid);
const groep2 = chauffeursVolgorde.slice(mid);

const voorjaarSetA = ["B541","L544","L549","A545","D541","M545"];
const najaarSetA = ["T545","H541","A541","Containers"];
const voorjaarSetB = najaarSetA;
const najaarSetB = voorjaarSetA;

const currentDate = new Date();
const month = currentDate.getMonth()+1;
const isVoorjaar = month<=6;
const evenYear = currentDate.getFullYear()%2===0;

function getVoertuigenVoorChauffeur(chauffeur){
  const inGroep1 = groep1.includes(chauffeur);
  if(inGroep1){
    return isVoorjaar?(evenYear?voorjaarSetB:najaarSetB):(evenYear?najaarSetB:voorjaarSetB);
  }else{
    return isVoorjaar?(evenYear?voorjaarSetA:najaarSetA):(evenYear?najaarSetA:voorjaarSetA);
  }
}

// ===================== RENDER =====================
const containerDiv = document.getElementById("chauffeurContainer");

function renderChauffeurs(filter=""){
  filter = (filter||"").toLowerCase();
  containerDiv.innerHTML="";

  chauffeursVolgorde.forEach(chauffeur=>{
    if(!isAdmin && chauffeur!==loggedInUser) return;
    if(filter && !chauffeur.toLowerCase().includes(filter)) return;

    const voertuigen = getVoertuigenVoorChauffeur(chauffeur);
    const card = document.createElement("div");
    card.className="chauffeur-card";

    let totaal=0, voltooid=0;

    const h3 = document.createElement("h3");
    h3.innerHTML=`${chauffeur}<span class="counter">${voltooid} / ${totaal} oefenmomenten voltooid</span>`;
    card.appendChild(h3);

    voertuigen.forEach(voertuig=>{
      if(!oefenmomenten[voertuig]) return;

      const vehicleDiv = document.createElement("div");
      vehicleDiv.className = "vehicle";

      const vehHeader = document.createElement("div");
      vehHeader.className = "veh-header";

      // Master checkbox
      const masterCheckbox = document.createElement("input");
      masterCheckbox.type="checkbox";
      masterCheckbox.style.marginRight="8px";
      const masterLabel = document.createElement("label");
      masterLabel.appendChild(masterCheckbox);
      masterLabel.appendChild(document.createTextNode("Alles"));
      vehHeader.textContent = "üöí " + voertuig;
      vehHeader.prepend(masterLabel);

      const exerciseDiv = document.createElement("div");
      exerciseDiv.className="exercise-list";

      oefenmomenten[voertuig].forEach(num=>{
        const label = document.createElement("label");
        const input = document.createElement("input");
        input.type = "checkbox";

        const key = `${chauffeur}/${voertuig}_${num}`;
        const ref = database.ref(`oefenmomenten/${key}`);

        // Realtime sync
        ref.on("value", snap=>{
          input.checked = snap.val()===true;
          updateCounter();
          updateMasterCheckbox();
        });

        input.addEventListener("change", ()=>{
          ref.set(input.checked);
        });

        label.appendChild(input);
        label.appendChild(document.createTextNode(` Oefenmoment ${num}`));
        exerciseDiv.appendChild(label);
      });

      // Master checkbox functionaliteit
      function updateMasterCheckbox(){
        const allChecked = Array.from(exerciseDiv.querySelectorAll("input[type=checkbox]"))
                            .every(cb=>cb.checked);
        masterCheckbox.checked = allChecked;
      }

      function updateCounter(){
        let done=0, total=0;
        oefenmomenten[voertuig].forEach(num=>{
          total++;
          const cb = exerciseDiv.querySelector(`label:nth-child(${num}) input`);
          if(cb && cb.checked) done++;
        });
        const oldText = h3.querySelector(".counter");
        oldText.textContent = `${done} / ${total} oefenmomenten voltooid`;
      }

      masterCheckbox.addEventListener("change", ()=>{
        const checked = masterCheckbox.checked;
        exerciseDiv.querySelectorAll("input[type=checkbox]").forEach((cb, i)=>{
          cb.checked = checked;
          const num = oefenmomenten[voertuig][i];
          database.ref(`oefenmomenten/${chauffeur}/${voertuig}_${num}`).set(checked);
        });
      });

      vehicleDiv.appendChild(vehHeader);
      vehicleDiv.appendChild(exerciseDiv);
      card.appendChild(vehicleDiv);
    });

    containerDiv.appendChild(card);
  });

  if(!containerDiv.hasChildNodes()){
    containerDiv.innerHTML="<div style='color:#666;padding:12px;border-radius:8px;background:#fff;border:1px dashed #ddd;'>Geen chauffeurs gevonden of geen rechten.</div>";
  }
}

renderChauffeurs();
document.getElementById("searchInput").addEventListener("input",function(){renderChauffeurs(this.value);});
</script>

<script src="/brandweerherentals/header.js"></script>
</body>
</html>
