function render(filter="") {
  containerDiv.innerHTML = "";
  filter = filter.toLowerCase();

  chauffeurs.forEach(chauffeur => {
    if(!isAdmin && chauffeur !== huidigeGebruiker) return;
    if(filter && !chauffeur.toLowerCase().includes(filter)) return;

    const voertuigen = getVoertuigenVoorChauffeur(chauffeur);
    const card = document.createElement("div");
    card.className = "chauffeur-card";

    const h3 = document.createElement("h3");
    const naamSpan = document.createElement("span");
    naamSpan.textContent = chauffeur;
    const counter = document.createElement("div");
    counter.className = "counter red";
    counter.textContent = "0 / 0";
    h3.appendChild(naamSpan);
    h3.appendChild(counter);
    card.appendChild(h3);

    const allCB = [];
    const totaal = voertuigen.reduce((s,v)=>s+(oefenmomenten[v]?.length||0),0);

    voertuigen.forEach(voertuig => {
      if(!oefenmomenten[voertuig]) return;

      const vDiv = document.createElement("div");
      vDiv.className = "vehicle";

      const vh = document.createElement("div");
      vh.className = "veh-header";

      const left = document.createElement("div");
      left.textContent = `ðŸš’ ${voertuig}`;

      const selectAll = document.createElement("input");
      selectAll.type = "checkbox";

      const sLabel = document.createElement("label");
      sLabel.className = "select-all-label";
      sLabel.append(selectAll, document.createTextNode(" Alles"));

      vh.appendChild(left);
      vh.appendChild(sLabel);
      vDiv.appendChild(vh);

      const lijst = document.createElement("div");
      lijst.className = "exercise-list";

      const vCB = [];
      let updatingAll = false; // âœ… Flag om te detecteren of "Alles" wordt gebruikt

      oefenmomenten[voertuig].forEach((nr, index) => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";

        vCB.push(cb);
        allCB.push(cb);

        label.append(cb, `Moment ${nr}`);
        lijst.appendChild(label);

        // Firebase listener
        onValue(ref(db, `oefenmomenten/${chauffeur}/${voertuig}/${nr}`), snapshot => {
          const val = snapshot.val();
          // Alleen updaten als we niet bezig zijn met "Alles"
          if (!updatingAll) {
            cb.checked = (val === true);
            selectAll.checked = vCB.every(x => x.checked);
            updateCounter();
          }
        });

        // Individuele checkbox listener
        cb.addEventListener("change", () => {
          saveCheckbox(chauffeur, voertuig, nr, cb.checked);
          if (!updatingAll) {
            selectAll.checked = vCB.every(x => x.checked);
          }
          updateCounter();
        });
      });

      // "Alles"-checkbox listener
      selectAll.addEventListener("change", () => {
        updatingAll = true; // we zijn bezig met alles aanvinken
        const checked = selectAll.checked;
        vCB.forEach((cb, i) => {
          cb.checked = checked;
          saveCheckbox(chauffeur, voertuig, oefenmomenten[voertuig][i], checked);
        });
        updatingAll = false; // klaar met alles aanvinken
        updateCounter();
      });

      vDiv.appendChild(lijst);
      card.appendChild(vDiv);
    });

    function updateCounter() {
      const voltooide = allCB.filter(x => x.checked).length;
      counter.textContent = `${voltooide} / ${totaal}`;
      counter.classList.remove("red","orange","green");
      if(totaal===0) counter.classList.add("orange");
      else if(voltooide===0) counter.classList.add("red");
      else if(voltooide>=totaal) counter.classList.add("green");
      else counter.classList.add("orange");
    }

    updateCounter();
    containerDiv.appendChild(card);
  });

  if(!containerDiv.hasChildNodes()){
    containerDiv.innerHTML = "<div style='padding:10px;color:#666'>Geen toegang of niets gevonden.</div>";
  }
}
