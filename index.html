<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals â€” Portal</title>

<link rel="stylesheet" href="style.css">
<meta name="theme-color" content="#c71f1f">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<!-- LOGIN -->
<div id="nameOverlay" style="display:none">
  <div class="box">
    <h2>ðŸ‘¤ Identificatie</h2>
    <input id="nameInput" placeholder="Voornaam Achternaam">
    <button id="saveName">Verder</button>
    <small id="nameError" style="display:none;color:#ff6b6b">
      Naam niet herkend
    </small>
  </div>
</div>

<div class="container" id="appContent" style="display:none">

<header>
  <div class="header-left">
    <img src="logo.png">
  </div>
  <div class="header-right">
    <div id="greeting"></div>
    <div id="datetime"></div>
  </div>
</header>

<main class="content">
  <div class="grid" id="buttonGrid"></div>
</main>

<footer>
  <div>Versie 1.2</div>
  <button onclick="logout()">Uitloggen</button>
</footer>

</div>

<script>
/******** FIREBASE ********/
firebase.initializeApp({
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

/******** DOM ********/
const nameOverlay = document.getElementById("nameOverlay");
const nameInput = document.getElementById("nameInput");
const saveName = document.getElementById("saveName");
const nameError = document.getElementById("nameError");
const appContent = document.getElementById("appContent");
const greeting = document.getElementById("greeting");
const buttonGrid = document.getElementById("buttonGrid");

/******** HELPERS ********/
function normalizeName(n){
  return n.trim().replace(/\s+/g," ").toLowerCase();
}

/******** LOGIN ********/
saveName.onclick = () => {
  const key = normalizeName(nameInput.value);

  db.ref("users/" + key).once("value", snap => {
    if(!snap.exists()){
      nameError.style.display = "block";
      return;
    }
    localStorage.setItem("userName", key);
    location.reload();
  });
};

/******** LINKS ********/
const links = {
  agenda:{title:"Agenda",icon:"ðŸ“…",desc:"Belangrijke data",url:"agenda.html",roles:[]},
  vehicle:{title:"Voertuigen",icon:"ðŸš’",desc:"Reservaties",url:"voertuigen.html",roles:[]},
  permanentie:{title:"Permanentie",icon:"ðŸ•’",desc:"Planning",url:"permanentieopgave.html",roles:[]},
  admin:{title:"Admin",icon:"ðŸ› ï¸",desc:"Beheer",url:"admin.html",roles:["admin"]}
};

/******** GRID ********/
function renderGrid(){
  const key = localStorage.getItem("userName");

  db.ref("users/" + key).once("value", snap => {
    const user = snap.val();
    greeting.innerText = `Welkom ${user.displayName}`;
    const roles = user.roles || [];

    buttonGrid.innerHTML = "";

    Object.values(links).forEach(l=>{
      if(l.roles.length && !l.roles.some(r=>roles.includes(r))) return;

      const a = document.createElement("a");
      a.className="btn";
      a.href=l.url;
      a.innerHTML=`
        <div class="icon">${l.icon}</div>
        <div>
          <div>${l.title}</div>
          <small>${l.desc}</small>
        </div>
      `;
      buttonGrid.appendChild(a);
    });
  });
}

/******** LOGOUT ********/
function logout(){
  localStorage.removeItem("userName");
  location.reload();
}

/******** CLOCK ********/
setInterval(()=>{
  document.getElementById("datetime").innerText =
    new Date().toLocaleString("nl-BE");
},1000);

/******** START ********/
window.addEventListener("DOMContentLoaded",()=>{
  if(!localStorage.getItem("userName")){
    nameOverlay.style.display="flex";
    return;
  }
  appContent.style.display="block";
  renderGrid();
});
</script>

</body>
</html>
