<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Permanentie Planning</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f8f8f8; margin:0; }
.container { max-width: 900px; margin: 2em auto; background:white; border-radius:18px; padding:16px; box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.header-logo { height:50px; }
.header-left, .header-right { display:inline-block; vertical-align:middle; }
.header-right { margin-left:16px; }
.header-greeting { font-size:1rem; color:#555; }
.header-name { font-size:1.5rem; font-weight:bold; color:#c71f1f; }
.backlink { display:inline-block; margin-bottom:12px; text-decoration:none; color:#555; }
.backlink .arrow { margin-right:4px; }

.btn { padding:10px 16px; background:#c71f1f; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; }
.btn:hover { background:#8f1515; }

.planning-kaart { background:#fff0f0; border-radius:16px; padding:12px; margin-bottom:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.planning-datum { font-weight:bold; margin-bottom:8px; color:#c71f1f; }
.planning-rij { display:flex; align-items:center; margin:4px 0; }
.planning-rij i { margin-right:8px; color:#c71f1f; width:20px; text-align:center; }
</style>
</head>
<body>

<div class="container">
  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo">
    </div>
    <div class="header-right">
      <div class="header-greeting">Permanentie</div>
      <div class="header-name">Planning</div>
    </div>
  </header>

  <div class="content">
    <a href="permanentieopgave.html" class="backlink"><span class="arrow">←</span> Terug</a>

    <!-- Knop: alleen admin kan planning maken -->
    <div style="margin:1em 0;">
      <button id="maakPlanningBtn" class="btn">Planning maken</button>
    </div>

    <!-- Planning wordt hier weergegeven -->
    <div id="planningContainer"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

const container = document.getElementById("planningContainer");
const btn = document.getElementById("maakPlanningBtn");

const isAdmin = true; // admin of niet
if (!isAdmin) btn.style.display = "none";

/**
 * Helper: kies random uit array, met teller-voorkeur
 */
function kiesRandomGebruiker(users) {
  if(users.length === 0) return null;
  // Sorteer op aantal keer ingepland (min eerst)
  users.sort((a,b)=> (a.count??0) - (b.count??0));
  const minCount = users[0].count??0;
  const minUsers = users.filter(u=> (u.count??0)===minCount);
  // Kies random uit deze
  const keuze = minUsers[Math.floor(Math.random()*minUsers.length)];
  return keuze;
}

/**
 * 1️⃣ Functie om planning weer te geven
 */
function bekijkPlanning() {
  db.ref("permanenties/planning").on("value", snapshot => {
    container.innerHTML = "";
    const data = snapshot.val() ?? {};

    if (!data || Object.keys(data).length===0) {
      container.innerHTML = "<p>Geen planning gevonden.</p>";
      return;
    }

    const maandKeys = Object.keys(data).sort((a,b)=>b.localeCompare(a));
    const maandKey = maandKeys[0];
    const maand = data[maandKey] ?? {};

    Object.keys(maand).sort().forEach(dagKey=>{
      const dag = maand[dagKey];
      if (!dag || !dag.datum || !dag.ploeg) return;

      const kaart = document.createElement("div");
      kaart.className = "planning-kaart";

      const d = new Date(dag.datum);
      const datumTekst = isNaN(d) ? dag.datum : d.toLocaleDateString("nl-BE",{weekday:"long", day:"numeric", month:"long"});

      kaart.innerHTML = `
        <div class="planning-datum">${datumTekst}</div>
        <div class="planning-rij"><i class="fa-solid fa-truck"></i> Chauffeur: <b>${dag.ploeg.chauffeur ?? "-"}</b></div>
        <div class="planning-rij"><i class="fa-solid fa-user-tie"></i> Bevelvoerder: <b>${dag.ploeg.bevelvoerder ?? "-"}</b></div>
        ${(dag.ploeg.brandweermannen??[]).map(n=>`<div class="planning-rij"><i class="fa-solid fa-fire"></i> Brandweerman: <b>${n}</b></div>`).join("")}
        <div class="planning-rij"><i class="fa-solid fa-graduation-cap"></i> Stagiair: <b>${dag.ploeg.stagiair ?? "-"}</b></div>
      `;
      container.appendChild(kaart);
    });
  });
}

/**
 * 2️⃣ Functie om planning automatisch te maken op basis van beschikbaarheden
 */
async function maakPlanning() {
  const beschikbaarhedenSnap = await db.ref("permanenties/beschikbaarheid").get();
  const beschikbaarheden = beschikbaarhedenSnap.val() ?? {};

  // verzamel per rol met teller
  const rolUsers = {chauffeur:[], bevelvoerder:[], brandweerman:[], stagiair:[]};
  for(const [uid, data] of Object.entries(beschikbaarheden)){
    const roles = data.roles ?? [];
    roles.forEach(r=>{
      rolUsers[r] = rolUsers[r] ?? [];
      rolUsers[r].push({naam:data.naam, count:data.count ?? 0});
    });
  }

  if(Object.values(rolUsers).some(arr=>arr.length===0)){
    alert("Niet genoeg beschikbaarheden voor alle rollen!");
    return;
  }

  // Plan voor de komende 7 dagen als voorbeeld
  const vandaag = new Date();
  for(let i=0;i<7;i++){
    const datum = new Date(vandaag);
    datum.setDate(vandaag.getDate()+i);
    const datumStr = datum.toISOString().slice(0,10);
    const jaarMaand = datumStr.slice(0,7);

    // Kies random gebruikers per rol, rekening houdend met teller
    const gekozenChauffeur = kiesRandomGebruiker(rolUsers.chauffeur);
    const gekozenBevelvoerder = kiesRandomGebruiker(rolUsers.bevelvoerder);

    // brandweermannen: max 2 per dag, geen duplicaten
    const tempBW = [...rolUsers.brandweerman];
    const gekozenBW = [];
    while(gekozenBW.length<2 && tempBW.length>0){
      const bw = kiesRandomGebruiker(tempBW);
      gekozenBW.push(bw.naam);
      // verwijder uit tempBW zodat niet dubbel
      tempBW.splice(tempBW.findIndex(u=>u.naam===bw.naam),1);
    }

    const gekozenStagiair = kiesRandomGebruiker(rolUsers.stagiair);

    // Update tellers
    if(gekozenChauffeur) gekozenChauffeur.count++;
    if(gekozenBevelvoerder) gekozenBevelvoerder.count++;
    rolUsers.brandweerman.forEach(u=>{
      if(gekozenBW.includes(u.naam)) u.count++;
    });
    if(gekozenStagiair) gekozenStagiair.count++;

    // Nieuwe dag opslaan
    const nieuweDag = {
      datum: datumStr,
      ploeg:{
        chauffeur: gekozenChauffeur?.naam??"-",
        bevelvoerder: gekozenBevelvoerder?.naam??"-",
        brandweermannen: gekozenBW,
        stagiair: gekozenStagiair?.naam??"-"
      }
    };

    await db.ref(`permanenties/planning/${jaarMaand}/${datumStr}`).set(nieuweDag);
  }

  alert("Planning voor 7 dagen succesvol aangemaakt!");
  bekijkPlanning();
}

// laad planning voor iedereen
bekijkPlanning();

// admin knop
if(isAdmin){
  btn.addEventListener("click", ()=>{ maakPlanning(); });
}
</script>
</body>
</html>
