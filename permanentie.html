<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brandweer Herentals — Permanenties</title>

<link rel="stylesheet" href="/brandweerherentals/style.css">
<script src="/brandweerherentals/header.js" defer></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAUkFsXiJ7MOIDFfC0AUk9DiT_BPIHzfEE",
    authDomain: "post-herentals.firebaseapp.com",
    projectId: "post-herentals",
    storageBucket: "post-herentals.appspot.com",
    messagingSenderId: "762725561089",
    appId: "1:762725561089:web:38c46cc8cf44d624252100"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
</script>

<style>
.container {
  max-width: 900px;
  margin: 0 auto;
}

#appHeader {
  background: #c71f1f;
  color: #fff;
  padding: 15px 20px;
  border-radius: 18px 18px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-logo { height: 48px; }

.page-content { padding: 22px; }

.backlink {
  color: #fff;
  font-weight: bold;
  text-decoration: none;
  display: inline-block;
  margin-bottom: 22px;
}

.permanentie-card {
  background: #f7f7f7;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 22px;
  box-shadow: 0 3px 6px rgba(0,0,0,.12);
}

.permanentie-card h3 {
  margin-bottom: 14px;
  color: #c71f1f;
}

.permanentie-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.permanentie-list li {
  display: grid;
  grid-template-columns: 220px 1fr;
  padding: 8px 10px;
  border-radius: 6px;
  margin-bottom: 4px;
  background: #fff;
}

@media (max-width: 600px) {
  .permanentie-list li {
    grid-template-columns: 180px 1fr;
  }
}

.functie {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.checkbox-person {
  transform: scale(1.3);
}

.naam {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.aanwezig-lijst {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.aanwezig-badge {
  font-size: .7rem;
  background: #c71f1f;
  color: #fff;
  padding: 2px 6px;
  border-radius: 6px;
}

.stagiair-plus {
  background: #fff2cc !important;
  border-left: 5px solid #f0b400;
}

.stagiair-badge {
  background: #f0b400;
  color: #fff;
  font-size: .7rem;
  padding: 2px 6px;
  border-radius: 6px;
}
</style>
</head>

<body>

<div class="container">

<header id="appHeader">
  <img src="/brandweerherentals/icons/logo.png" class="header-logo">
  <div class="header-right">
    <div id="greeting"></div>
    <div id="datetime"></div>
    <div id="ploegOfWeek"></div>
  </div>
</header>

<div class="page-content">

<a href="/brandweerherentals/" class="backlink">← Terug</a>

<div id="permanentieContainer"></div>

</div>
</div>

<script type="module">
import {
  doc, setDoc, onSnapshot, collection, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const container = document.getElementById('permanentieContainer');
const gebruikersNaam = "Jonas";

fetch('/brandweerherentals/permanentie.json')
.then(r => r.json())
.then(data => {

  const today = new Date(); today.setHours(0,0,0,0);

  data.dagen.forEach(dag => {

    const d = new Date(dag.datum);
    if (d < today) return;

    const card = document.createElement('div');
    card.className = 'permanentie-card';

    const dateStr = d.toLocaleDateString('nl-BE',{weekday:'long',day:'2-digit',month:'long'});
    let html = `<h3>${dateStr}</h3><ul class="permanentie-list">`;

    dag.diensten.forEach(p => {
      const id = `${dag.datum}_${p.functie}_${p.naam.replaceAll(' ','_')}`;

      html += `
      <li>
        <span class="functie">
          <input type="checkbox" class="checkbox-person" id="${id}">
          ${p.functie}
        </span>
        <span class="naam">
          ${p.naam || '<em>Vrij</em>'}
          <div class="aanwezig-lijst" id="lijst_${id}"></div>
        </span>
      </li>`;
    });

    html += '</ul>';
    card.innerHTML = html;
    container.appendChild(card);

    dag.diensten.forEach(p => {
      const baseId = `${dag.datum}_${p.functie}_${p.naam.replaceAll(' ','_')}`;
      const checkbox = document.getElementById(baseId);
      const lijst = document.getElementById(`lijst_${baseId}`);

      const q = query(
        collection(db,"permanentieAanwezigheden"),
        where("baseId","==",baseId),
        where("aanwezig","==",true)
      );

      onSnapshot(q, snap => {
        lijst.innerHTML = '';
        snap.forEach(d => {
          const b = document.createElement('span');
          b.className = 'aanwezig-badge';
          b.textContent = d.data().naam;
          lijst.appendChild(b);
        });
      });

      const ref = doc(db,"permanentieAanwezigheden",`${baseId}_${gebruikersNaam}`);

      onSnapshot(ref,s=>{
        if(s.exists()) checkbox.checked = s.data().aanwezig;
      });

      checkbox.addEventListener('change',()=>{
        setDoc(ref,{
          baseId,
          naam: gebruikersNaam,
          aanwezig: checkbox.checked,
          ts: Date.now()
        });
      });
    });

  });
});
</script>

</body>
</html>
