<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Permanentie Maandplanning</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f8f8f8; margin:0; }
.container { max-width: 900px; margin: 2em auto; background:white; border-radius:18px; padding:16px; box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.header-logo { height:50px; }
.header-left, .header-right { display:inline-block; vertical-align:middle; }
.header-right { margin-left:16px; }
.header-greeting { font-size:1rem; color:#555; }
.header-name { font-size:1.5rem; font-weight:bold; color:#c71f1f; }
.backlink { display:inline-block; margin-bottom:12px; text-decoration:none; color:#555; }
.backlink .arrow { margin-right:4px; }

.btn { padding:10px 16px; background:#c71f1f; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; }
.btn:hover { background:#8f1515; }

.planning-kaart { background:#fff0f0; border-radius:16px; padding:12px; margin-bottom:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.planning-datum { font-weight:bold; margin-bottom:8px; color:#c71f1f; }
.planning-rij { display:flex; align-items:center; margin:4px 0; }
.planning-rij i { margin-right:8px; color:#c71f1f; width:20px; text-align:center; }
</style>
</head>
<body>

<div class="container">
  <header id="appHeader">
    <div class="header-left">
      <img src="logo.png" class="header-logo">
    </div>
    <div class="header-right">
      <div class="header-greeting">Permanentie</div>
      <div class="header-name">Maandplanning</div>
    </div>
  </header>

  <div class="content">
    <a href="permanentieopgave.html" class="backlink"><span class="arrow">‚Üê</span> Terug</a>

    <div style="margin:1em 0;">
      <button id="maakPlanningBtn" class="btn">Planning maken</button>
    </div>

    <div id="planningContainer"></div>
  </div>
</div>

<script>
firebase.initializeApp({
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

const container = document.getElementById("planningContainer");
const btn = document.getElementById("maakPlanningBtn");
const isAdmin = true;
if(!isAdmin) btn.style.display = "none";

/** Kies random gebruiker met teller-check */
function kiesRandomGebruiker(users){
  if(users.length===0) return null;
  users.sort((a,b)=>(a.count??0)-(b.count??0));
  const minCount = users[0].count??0;
  const minUsers = users.filter(u=>(u.count??0)===minCount);
  return minUsers[Math.floor(Math.random()*minUsers.length)];
}

/** Bekijk planning */
function bekijkPlanning(){
  db.ref("permanenties/planning").on("value", snapshot=>{
    container.innerHTML="";
    const data = snapshot.val()??{};
    if(!data || Object.keys(data).length===0){
      container.innerHTML="<p>Geen planning gevonden.</p>";
      return;
    }
    const maandKeys = Object.keys(data).sort((a,b)=>b.localeCompare(a));
    const maandKey = maandKeys[0];
    const maand = data[maandKey]??{};

    Object.keys(maand).sort().forEach(dagKey=>{
      const dag = maand[dagKey];
      if(!dag||!dag.datum||!dag.ploeg) return;

      const kaart = document.createElement("div");
      kaart.className="planning-kaart";
      const d = new Date(dag.datum);
      const datumTekst = isNaN(d)?dag.datum:d.toLocaleDateString("nl-BE",{weekday:"long", day:"numeric", month:"long"});

      kaart.innerHTML=`
        <div class="planning-datum">${datumTekst}</div>
        <div class="planning-rij"><i class="fa-solid fa-user-tie"></i> Bevelvoerder: <b>${dag.ploeg.bevelvoerder??"-"}</b></div>
        <div class="planning-rij"><i class="fa-solid fa-truck"></i> Chauffeur: <b>${dag.ploeg.chauffeur??"-"}</b></div>
        ${(dag.ploeg.brandweermannen??[]).map(n=>`<div class="planning-rij"><i class="fa-solid fa-fire"></i> Brandweerman: <b>${n}</b></div>`).join("")}
        <div class="planning-rij"><i class="fa-solid fa-graduation-cap"></i> Stagiair: <b>${dag.ploeg.stagiair??"-"}</b></div>
      `;
      container.appendChild(kaart);
    });
  });
}

/** Maak maandplanning */
async function maakMaandPlanning(){
  const beschikbaarSnap = await db.ref("permanenties/beschikbaarheid").get();
  const beschikbaarheden = beschikbaarSnap.val()??{};

  // Gebruikers per rol
  const rolUsers = {chauffeur:[], bevelvoerder:[], brandweerman:[], stagiair:[]};
  for(const [uid,data] of Object.entries(beschikbaarheden)){
    const roles = data.roles??[];
    roles.forEach(r=>{
      rolUsers[r] = rolUsers[r]??[];
      rolUsers[r].push({naam:data.naam, count:data.count??0});
    });
  }

  if(rolUsers.chauffeur.length===0 || rolUsers.bevelvoerder.length===0 || rolUsers.brandweerman.length<4){
    alert("Niet genoeg beschikbaarheden voor alle rollen!");
    return;
  }

  const vandaag = new Date();
  const maand = vandaag.getMonth();
  const jaar = vandaag.getFullYear();
  const dagenInMaand = new Date(jaar, maand+1, 0).getDate();

  for(let dag=1; dag<=dagenInMaand; dag++){
    const datum = new Date(jaar, maand, dag);
    const datumStr = datum.toISOString().slice(0,10);
    const jaarMaand = datumStr.slice(0,7);

    // Kies Bevelvoerder & Chauffeur
    const gekozenBevelvoerder = kiesRandomGebruiker(rolUsers.bevelvoerder);
    const gekozenChauffeur = kiesRandomGebruiker(rolUsers.chauffeur);

    // Kies 4 Brandweermannen
    const tempBW = [...rolUsers.brandweerman];
    const gekozenBW = [];
    while(gekozenBW.length<4 && tempBW.length>0){
      const bw = kiesRandomGebruiker(tempBW);
      gekozenBW.push(bw.naam);
      tempBW.splice(tempBW.findIndex(u=>u.naam===bw.naam),1);
    }

    // Kies Stagiair (optioneel)
    let gekozenStagiair = null;
    if(rolUsers.stagiair.length>0 && Math.random()>0.5){
      gekozenStagiair = kiesRandomGebruiker(rolUsers.stagiair);
    }

    // Update tellers
    if(gekozenBevelvoerder) gekozenBevelvoerder.count++;
    if(gekozenChauffeur) gekozenChauffeur.count++;
    rolUsers.brandweerman.forEach(u=>{ if(gekozenBW.includes(u.naam)) u.count++; });
    if(gekozenStagiair) gekozenStagiair.count++;

    const nieuweDag = {
      datum: datumStr,
      ploeg:{
        bevelvoerder: gekozenBevelvoerder?.naam??"-",
        chauffeur: gekozenChauffeur?.naam??"-",
        brandweermannen: gekozenBW,
        stagiair: gekozenStagiair?.naam??"-"
      }
    };

    await db.ref(`permanenties/planning/${jaarMaand}/${datumStr}`).set(nieuweDag);
  }

  alert(`Planning voor ${dagenInMaand} dagen succesvol aangemaakt!`);
  bekijkPlanning();
}

// laad planning
bekijkPlanning();

// admin knop
if(isAdmin){
  btn.addEventListener("click", ()=>{ maakMaandPlanning(); });
}
</script>
</body>
</html>
