<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personeelsfeuille â€” Brandweer Herentals</title>
<link rel="stylesheet" href="style.css">
<style>
#pdfContainer {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 20px auto;
    border: 1px solid #ccc;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
}

.pdfCanvas {
    width: 100%;
    display: block;
}

.overlay-field {
    position: absolute;
    font-size: 0.9rem;
    border-radius: 6px;
    padding: 4px 6px;
    border: 1px solid #ccc;
    background: rgba(255,255,255,0.9);
    color: #111;
}

.overlay-select {
    position: absolute;
    border-radius: 6px;
    padding: 2px 4px;
    border: 1px solid #ccc;
    background: rgba(255,255,255,0.9);
    color: #111;
}

#downloadBtn {
    margin: 20px;
    padding: 12px 20px;
    border:none;
    border-radius:10px;
    background:#c71f1f;
    color:#fff;
    font-weight:700;
    font-size:1rem;
    cursor:pointer;
}
</style>
</head>
<body>

<div class="container">
<header id="appHeader">
    <img src="/brandweerherentals/icons/logo.png" class="header-logo">
    <div class="header-text">
        <div id="greeting" class="header-greeting"></div>
        <div id="datetime" class="header-datetime"></div>
        <div id="ploegOfWeek" class="header-ploeg"></div>
    </div>
</header>

<main style="padding:15px;">
<h2>Personeelsfeuille</h2>
<div id="pdfContainer">
    <canvas id="pdfCanvas" class="pdfCanvas"></canvas>

    <!-- Voorbeeld invulvelden -->
    <input type="date" id="datum" class="overlay-field" style="top:50px; left:100px; width:150px;">
    <input type="text" id="omschrijving" class="overlay-field" style="top:50px; left:300px; width:300px;">
    <input type="time" id="beginUur" class="overlay-field" style="top:100px; left:100px; width:100px;">
    <input type="time" id="eindUur" class="overlay-field" style="top:100px; left:220px; width:100px;">
    <input type="text" id="locatie" class="overlay-field" style="top:100px; left:340px; width:200px;">

    <select id="kolom" class="overlay-select" style="top:150px; left:100px; width:200px;">
        <option value="">-- Kies --</option>
        <option value="Interventie">Interventie</option>
        <option value="Ambulance">Ambulance</option>
        <option value="Onderhoud/dienstopdracht">Onderhoud/dienstopdracht</option>
        <option value="Wacht/permanentie">Wacht/permanentie</option>
    </select>

    <select id="XDKO" class="overlay-select" style="top:150px; left:320px; width:80px;">
        <option value="">-- Kies --</option>
        <option value="X">X</option>
        <option value="D">D</option>
        <option value="K">K</option>
        <option value="O">O</option>
    </select>

    <input type="text" id="voertuig" class="overlay-field" style="top:150px; left:420px; width:150px;">
    <input type="text" id="handtekening" class="overlay-field" style="top:150px; left:600px; width:200px;">
    <input type="time" id="afwijkendBegin" class="overlay-field" style="top:200px; left:100px; width:100px;">
    <input type="time" id="afwijkendEind" class="overlay-field" style="top:200px; left:220px; width:100px;">
    <input type="text" id="opmerking" class="overlay-field" style="top:200px; left:340px; width:400px;">
</div>

<button id="downloadBtn">ðŸ“„ PDF downloaden</button>

</main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js';
import jsPDF from 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';

const firebaseConfig = {
    apiKey: "AIzaSyAUkFsXiJ7MOIDFfC0AUk9DiT_BPIHzfEE",
    authDomain: "post-herentals.firebaseapp.com",
    databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "post-herentals",
    storageBucket: "post-herentals.firebasestorage.app",
    messagingSenderId: "762725561089",
    appId: "1:762725561089:web:38c46cc8cf44d624252100",
    measurementId: "G-C2FWECFEQX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const pdfUrl = '/brandweerherentals/personeelsfeuille.pdf';
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');

pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
    pdf.getPage(1).then(page => {
        const viewport = page.getViewport({ scale: 1.2 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        page.render({ canvasContext: ctx, viewport: viewport });
    });
});

const velden = ["datum","omschrijving","beginUur","eindUur","locatie","kolom","XDKO","voertuig","handtekening","afwijkendBegin","afwijkendEind","opmerking"];
const sheetKey = new Date().toISOString().slice(0,10);

velden.forEach(v => {
    const input = document.getElementById(v);
    const refField = ref(db, `personeelsfeuille/${sheetKey}/${v}`);

    // Live update
    onValue(refField, snapshot => {
        if(input.type === "checkbox") input.checked = snapshot.val()===true;
        else input.value = snapshot.val()||'';
    });

    // Opslaan
    input.addEventListener("input", () => set(refField, input.value));
});

// ðŸ“„ PDF export
document.getElementById("downloadBtn").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const pdfExport = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [canvas.width, canvas.height]
    });

    // Achtergrond originele PDF
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    pdfExport.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);

    // Overlay velden toevoegen
    pdfExport.setFontSize(12);
    pdfExport.setTextColor(0,0,0);

    velden.forEach(v => {
        const el = document.getElementById(v);
        if(el.value) {
            const rect = el.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const x = rect.left - canvasRect.left;
            const y = rect.top - canvasRect.top + 4; // kleine offset
            pdfExport.text(String(el.value), x, y);
        }
    });

    pdfExport.save(`Personeelsfeuille_${sheetKey}.pdf`);
});
</script>

<script src="/brandweerherentals/header.js"></script>
</body>
</html>
