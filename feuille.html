<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personeelsfeuille â€” Brandweer Herentals</title>
<link rel="stylesheet" href="style.css">
<style>
  /* Container & PDF + overlay styling */
  #pdfContainer {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 20px auto;
    border: 1px solid #ccc;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
  }
  .pdfCanvas {
    width: 100%;
    display: block;
  }
  .overlay-field, .overlay-select {
    position: absolute;
    font-size: 0.9rem;
    border-radius: 6px;
    padding: 4px 6px;
    border: 1px solid #ccc;
    background: rgba(255,255,255,0.9);
    color: #000;
  }
  #downloadBtn {
    margin: 20px;
    padding: 12px 20px;
    border:none;
    border-radius:10px;
    background:#c71f1f;
    color:#fff;
    font-weight:700;
    font-size:1rem;
    cursor:pointer;
  }
</style>
</head>
<body>
<div class="container">
  <!-- HEADER zoals in jullie app -->
  <header id="appHeader">
    <img src="/brandweerherentals/icons/logo.png" class="header-logo" alt="Brandweer Herentals">
    <div class="header-text">
      <div id="greeting" class="header-greeting"></div>
      <div id="datetime" class="header-datetime"></div>
      <div id="ploegOfWeek" class="header-ploeg"></div>
    </div>
  </header>

  <main style="padding:15px;">
    <h2>Personeelsfeuille</h2>
    <div id="pdfContainer">
      <canvas id="pdfCanvas" class="pdfCanvas"></canvas>

      <!-- Hier komen invulvelden; pas top/left/width aan volgens PDF -->
      <input type="date" id="veld_datum" class="overlay-field" style="top:80px; left:50px; width:140px;">
      <input type="text" id="veld_omschrijving" class="overlay-field" style="top:80px; left:220px; width:350px;">
      <input type="time" id="veld_begin" class="overlay-field" style="top:130px; left:50px; width:90px;">
      <input type="time" id="veld_eind" class="overlay-field" style="top:130px; left:160px; width:90px;">
      <input type="text" id="veld_locatie" class="overlay-field" style="top:130px; left:270px; width:200px;">

      <select id="veld_kolom" class="overlay-select" style="top:180px; left:50px; width:200px;">
        <option value="">-- Kies --</option>
        <option value="Interventie">Interventie</option>
        <option value="Ambulance">Ambulance</option>
        <option value="Onderhoud/dienstopdracht">Onderhoud / Dienst</option>
        <option value="Wacht/permanentie">Wacht / Permanentie</option>
      </select>

      <select id="veld_XDKO" class="overlay-select" style="top:180px; left:260px; width:70px;">
        <option value="">--</option>
        <option value="X">X</option>
        <option value="D">D</option>
        <option value="K">K</option>
        <option value="O">O</option>
      </select>

      <input type="text" id="veld_voertuig" class="overlay-field" style="top:180px; left:350px; width:150px;">
      <input type="text" id="veld_handtekening" class="overlay-field" style="top:180px; left:520px; width:200px;">
      <input type="time" id="veld_afwijkendBegin" class="overlay-field" style="top:230px; left:50px; width:90px;">
      <input type="time" id="veld_afwijkendEind" class="overlay-field" style="top:230px; left:160px; width:90px;">
      <input type="text" id="veld_opmerking" class="overlay-field" style="top:230px; left:270px; width:350px;">

    </div>

    <button id="downloadBtn">ðŸ“„ Download ingevulde PDF</button>
  </main>
</div>

<script type="module">
// Firebase import & init
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js';
import { jsPDF } from 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';

const firebaseConfig = {
  apiKey: "AIzaSyAUkFsXiJ7MOIDFfC0AUk9DiT_BPIHzfEE",
  authDomain: "post-herentals.firebaseapp.com",
  databaseURL: "https://post-herentals-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "post-herentals",
  storageBucket: "post-herentals.firebasestorage.app",
  messagingSenderId: "762725561089",
  appId: "1:762725561089:web:38c46cc8cf44d624252100",
  measurementId: "G-C2FWECFEQX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Render de PDF in canvas
const pdfUrl = '/brandweerherentals/personeelsfeuille.pdf';
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');

pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
  pdf.getPage(1).then(page => {
    const viewport = page.getViewport({ scale: 1.5 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    page.render({ canvasContext: ctx, viewport }).promise.then(() => {
      console.log("PDF geladen");
    });
  });
});

// Velden identificeren
const velden = [
  'veld_datum','veld_omschrijving','veld_begin','veld_eind','veld_locatie',
  'veld_kolom','veld_XDKO','veld_voertuig','veld_handtekening',
  'veld_afwijkendBegin','veld_afwijkendEind','veld_opmerking'
];

// Unieke sleutel (bvb datum of autoâ€‘id etc)
const sheetKey = new Date().toISOString().slice(0,10);

// Hooks voor live data
velden.forEach(id => {
  const el = document.getElementById(id);
  const dbRef = ref(db, `personeelsfeuille/${sheetKey}/${id}`);

  onValue(dbRef, snap => {
    if(el.tagName === 'SELECT' || el.tagName === 'INPUT') {
      el.value = snap.val() ?? '';
    }
  });

  el.addEventListener('input', () => {
    set(dbRef, el.value);
  });
});

// PDF downoad functie
document.getElementById("downloadBtn").addEventListener("click", () => {
  const pdfOut = new jsPDF({
    unit: 'px',
    format: [canvas.width, canvas.height]
  });

  const img = canvas.toDataURL('image/jpeg', 1.0);
  pdfOut.addImage(img, 'JPEG', 0, 0, canvas.width, canvas.height);

  pdfOut.setFontSize(12);
  pdfOut.setTextColor(0,0,0);

  velden.forEach(id => {
    const el = document.getElementById(id);
    if (!el.value) return;
    const rect = el.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    const x = rect.left - canvasRect.left;
    const y = rect.top - canvasRect.top + 4;
    pdfOut.text(String(el.value), x, y);
  });

  pdfOut.save(`Personeelsfeuille_${sheetKey}.pdf`);
});
</script>
<script src="/brandweerherentals/header.js"></script>
</body>
</html>
